# RabbitMQ




## ä¸€ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—

å°çº¢æ˜¯å°æ˜çš„å§å§ã€‚å°çº¢å¸Œæœ›å°æ˜å¤šè¯»ä¹¦ï¼Œå¸¸å¯»æ‰¾å¥½ä¹¦ç»™å°æ˜çœ‹ï¼Œä¹‹å‰çš„æ–¹å¼æ˜¯è¿™æ ·ï¼šå°çº¢é—®å°æ˜ä»€ä¹ˆæ—¶å€™æœ‰ç©ºï¼ŒæŠŠä¹¦ç»™å°æ˜é€å»ï¼Œå¹¶äº²çœ¼ç›‘ç£å°æ˜è¯»å®Œä¹¦æ‰èµ°ã€‚ä¹…è€Œä¹…ä¹‹ï¼Œä¸¤äººéƒ½è§‰å¾—éº»çƒ¦ã€‚åæ¥çš„æ–¹å¼æ”¹æˆäº†ï¼šå°çº¢å¯¹å°æ˜è¯´ã€Œæˆ‘æ”¾åˆ°ä¹¦æ¶ä¸Šçš„ä¹¦ä½ éƒ½è¦çœ‹ã€ï¼Œç„¶åå°çº¢æ¯æ¬¡å‘ç°ä¸é”™çš„ä¹¦éƒ½æ”¾åˆ°ä¹¦æ¶ä¸Šï¼Œå°æ˜åˆ™çœ‹åˆ°ä¹¦æ¶ä¸Šæœ‰ä¹¦å°±æ‹¿ä¸‹æ¥çœ‹ã€‚ä¹¦æ¶å°±æ˜¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå°çº¢æ˜¯ç”Ÿäº§è€…ï¼Œå°æ˜æ˜¯æ¶ˆè´¹è€…ã€‚è¿™å¸¦æ¥çš„å¥½å¤„æœ‰ï¼š1.å°çº¢æƒ³ç»™å°æ˜ä¹¦çš„æ—¶å€™ï¼Œä¸å¿…é—®å°æ˜ä»€ä¹ˆæ—¶å€™æœ‰ç©ºï¼Œäº²æ‰‹æŠŠä¹¦äº¤ç»™ä»–äº†ï¼Œå°çº¢åªæŠŠä¹¦æ”¾åˆ°ä¹¦æ¶ä¸Šå°±è¡Œäº†ã€‚è¿™æ ·å°çº¢å°æ˜çš„æ—¶é—´éƒ½æ›´è‡ªç”±ã€‚2.å°çº¢ç›¸ä¿¡å°æ˜çš„è¯»ä¹¦è‡ªè§‰å’Œè¯»ä¹¦èƒ½åŠ›ï¼Œä¸å¿…äº²çœ¼è§‚å¯Ÿå°æ˜çš„è¯»ä¹¦è¿‡ç¨‹ï¼Œå°çº¢åªè¦åšä¸€ä¸ªæ”¾ä¹¦çš„åŠ¨ä½œï¼Œå¾ˆèŠ‚çœæ—¶é—´ã€‚3.å½“æ˜å¤©æœ‰å¦ä¸€ä¸ªçˆ±è¯»ä¹¦çš„å°ä¼™ä¼´å°å¼ºåŠ å…¥ï¼Œå°çº¢ä»æ—§åªéœ€è¦æŠŠä¹¦æ”¾åˆ°ä¹¦æ¶ä¸Šï¼Œå°æ˜å’Œå°å¼ºä»ä¹¦æ¶ä¸Šå–ä¹¦å³å¯ï¼ˆå””ï¼Œå§‘ä¸”è®¾å®šæˆå¤šä¸ªäººå–ä¸€æœ¬ä¹¦å¯ä»¥æ¯äººå–èµ°ä¸€æœ¬å§ï¼Œå¯èƒ½æ˜¯æ‹·è´ç”µå­ä¹¦æˆ–å¤å°ï¼Œæš‚ä¸è€ƒè™‘ç‰ˆæƒé—®é¢˜ï¼‰ã€‚4.ä¹¦æ¶ä¸Šçš„ä¹¦æ”¾åœ¨é‚£é‡Œï¼Œå°æ˜é˜…è¯»é€Ÿåº¦å¿«å°±æ—©ç‚¹çœ‹å®Œï¼Œé˜…è¯»é€Ÿåº¦æ…¢å°±æ™šç‚¹çœ‹å®Œï¼Œæ²¡å…³ç³»ï¼Œæ¯”èµ·å°çº¢æŠŠä¹¦é€’ç»™å°æ˜å¹¶ç›‘ç£å°æ˜è¯»å®Œçš„æ–¹å¼ï¼Œå°æ˜çš„å‹åŠ›ä¼šå°ä¸€äº›ã€‚è¿™å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„å››å¤§å¥½å¤„ï¼š1.è§£è€¦æ¯ä¸ªæˆå‘˜ä¸å¿…å—å…¶ä»–æˆå‘˜å½±å“ï¼Œå¯ä»¥æ›´ç‹¬ç«‹è‡ªä¸»ï¼Œåªé€šè¿‡ä¸€ä¸ªç®€å•çš„å®¹å™¨æ¥è”ç³»ã€‚å°çº¢ç”šè‡³å¯ä»¥ä¸çŸ¥é“ä»ä¹¦æ¶ä¸Šå–ä¹¦çš„æ˜¯è°ï¼Œå°æ˜ä¹Ÿå¯ä»¥ä¸çŸ¥é“å¾€ä¹¦æ¶ä¸Šæ”¾ä¹¦çš„äººæ˜¯è°ï¼Œåœ¨ä»–ä»¬çœ¼é‡Œï¼Œéƒ½åªæœ‰ä¹¦æ¶ï¼Œæ²¡æœ‰å¯¹æ–¹ã€‚æ¯«æ— ç–‘é—®ï¼Œä¸ä¸€ä¸ªç®€å•çš„å®¹å™¨æ‰“äº¤é“ï¼Œæ¯”ä¸å¤æ‚çš„äººæ‰“äº¤é“å®¹æ˜“ä¸€ä¸‡å€ï¼Œå°çº¢å°æ˜å¯ä»¥è‡ªç”±è‡ªåœ¨åœ°è¿½æ±‚å„è‡ªçš„äººç”Ÿã€‚2.æé€Ÿå°çº¢é€‰æ‹©ç›¸ä¿¡ã€ŒæŠŠä¹¦æ”¾åˆ°ä¹¦æ¶ä¸Šï¼Œåˆ«çš„æˆ‘ä¸é—®ã€ï¼Œä¸ºè‡ªå·±èŠ‚çœäº†å¤§é‡æ—¶é—´ã€‚å°çº¢å¾ˆå¿™ï¼Œåªèƒ½æŠ½å‡ºäº”åˆ†é’Ÿæ—¶é—´ï¼Œä½†è¿™æ—¶é—´è¶³å¤ŸæŠŠä¹¦æ”¾åˆ°ä¹¦æ¶ä¸Šäº†ã€‚3.å¹¿æ’­å°çº¢åªéœ€è¦åŠ³åŠ¨ä¸€æ¬¡ï¼Œå°±å¯ä»¥è®©å¤šä¸ªå°ä¼™ä¼´æœ‰ä¹¦å¯è¯»ï¼Œè¿™å¤§å¤§åœ°èŠ‚çœäº†å¥¹çš„æ—¶é—´ï¼Œä¹Ÿè®©æ–°çš„å°ä¼™ä¼´çš„åŠ å…¥æˆæœ¬å¾ˆä½ã€‚4.å‰Šå³°å‡è®¾å°æ˜è¯»ä¹¦å¾ˆæ…¢ï¼Œå¦‚æœé‡‡ç”¨å°çº¢æ¯ç»™ä¸€æœ¬ä¹¦éƒ½ç›‘ç£å°æ˜è¯»å®Œçš„æ–¹å¼ï¼Œå°æ˜æœ‰å‹åŠ›ï¼Œå°çº¢ä¹Ÿä¸è€çƒ¦ã€‚åæ­£å°çº¢ç»™ä¹¦çš„é¢‘ç‡ä¹Ÿä¸ç¨³å®šï¼Œå¦‚æœä»Šæ˜ä¸¤å¤©è¿ç»™äº†äº”æœ¬ï¼Œä¹‹åéš”ä¸‰ä¸ªæœˆæ‰åˆç»™ä¸€æœ¬ï¼Œé‚£å°æ˜åªè¦åœ¨ä¸‰ä¸ªæœˆå†…ä»ä¹¦æ¶ä¸Šé™†ç»­å–èµ°äº”æœ¬ä¹¦è¯»å®Œå°±è¡Œäº†ï¼Œå‹åŠ›å°±ä¸é‚£ä¹ˆå¤§äº†ã€‚å½“ç„¶ï¼Œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæœ‰å…¶æˆæœ¬ï¼š1.å¼•å…¥å¤æ‚åº¦æ¯«æ— ç–‘é—®ï¼Œã€Œä¹¦æ¶ã€è¿™ä¸œè¥¿æ˜¯å¤šå‡ºæ¥çš„ï¼Œéœ€è¦åœ°æ–¹æ”¾å®ƒï¼Œè¿˜éœ€è¦é˜²ç›—ã€‚2.æš‚æ—¶çš„ä¸ä¸€è‡´æ€§å‡å¦‚å¦ˆå¦ˆé—®å°çº¢ã€Œå°æ˜æœ€è¿‘è¯»äº†ä»€ä¹ˆä¹¦ã€ï¼Œåœ¨ä»¥å‰çš„æ–¹å¼é‡Œï¼Œå°çº¢å› ä¸ºäº²çœ¼ç›‘ç£å°æ˜è¯»å®Œä¹¦äº†ï¼Œå¯ä»¥åº•æ°”åè¶³åœ°å‘Šè¯‰å¦ˆå¦ˆï¼Œä½†æ–°çš„æ–¹å¼é‡Œï¼Œå°çº¢å›ç­”å¦ˆå¦ˆä¹‹åä¼šå¿ƒæƒ³ã€Œå°æ˜åº”è¯¥ä¼šå¾ˆå¿«çœ‹å®Œå§â€¦â€¦ã€è¿™ä¸­é—´å­˜åœ¨ç€ä¸€æ®µã€Œå¦ˆå¦ˆè®¤ä¸ºå°æ˜çœ‹äº†æŸä¹¦ï¼Œè€Œå°æ˜å…¶å®è¿˜æ²¡çœ‹ã€çš„æ—¶æœŸï¼Œå½“ç„¶ï¼Œå°æ˜æœ€ç»ˆçš„é˜…è¯»çŠ¶æ€ä¸å¦ˆå¦ˆçš„è®¤çŸ¥ä¼šæ˜¯ä¸€è‡´çš„ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ã€Œæœ€ç»ˆä¸€è‡´æ€§ã€ã€‚é‚£ä¹ˆï¼Œè¯¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„æƒ…å†µéœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶å‘¢ï¼Ÿ1.ç”Ÿäº§è€…ä¸éœ€è¦ä»æ¶ˆè´¹è€…å¤„è·å¾—åé¦ˆå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¹‹å‰çš„ç›´æ¥è°ƒç”¨ï¼Œå…¶æ¥å£çš„è¿”å›å€¼åº”è¯¥ä¸ºç©ºï¼Œè¿™æ‰è®©æ˜æ˜ä¸‹å±‚çš„åŠ¨ä½œè¿˜æ²¡åšï¼Œä¸Šå±‚å´å½“æˆåŠ¨ä½œåšå®Œäº†ç»§ç»­å¾€åèµ°â€”â€”å³æ‰€è°“å¼‚æ­¥â€”â€”æˆä¸ºäº†å¯èƒ½ã€‚å°çº¢æ”¾å®Œä¹¦ä¹‹åå°æ˜åˆ°åº•çœ‹äº†æ²¡æœ‰ï¼Œå°çº¢æ ¹æœ¬ä¸é—®ï¼Œå¥¹é»˜è®¤ä»–æ˜¯çœ‹äº†ï¼Œå¦åˆ™å°±åªèƒ½ç”¨åŸæ¥çš„æ–¹æ³•ç›‘ç£åˆ°çœ‹å®Œäº†ã€‚2.å®¹è®¸çŸ­æš‚çš„ä¸ä¸€è‡´æ€§å¦ˆå¦ˆå¯èƒ½ä¼šå‘ç°ã€Œæœ‰æ—¶å€™æ®è¯´å°æ˜çœ‹äº†æŸä¹¦ï¼Œä½†äº‹å®ä¸Šä»–è¿˜æ²¡çœ‹ã€ï¼Œåªè¦å¦ˆå¦ˆæ»¡æ„äºã€Œåæ­£ä»–æœ€åçœ‹äº†å°±è¡Œã€ï¼Œå¼‚æ­¥å¤„ç†å°±æ²¡é—®é¢˜ã€‚å¦‚æœå¦ˆå¦ˆå¯¹è¿™æƒ…å†µä¸èƒ½å®¹å¿ï¼Œå¯¹å°çº¢å¤§å‘é›·éœ†ï¼Œå°çº¢ä¹Ÿå°±ä¸æ•¢ç”¨ä¹¦æ¶æ–¹å¼äº†ã€‚3.ç¡®å®æ˜¯ç”¨äº†æœ‰æ•ˆæœå³è§£è€¦ã€æé€Ÿã€å¹¿æ’­ã€å‰Šå³°è¿™äº›æ–¹é¢çš„æ”¶ç›Šï¼Œè¶…è¿‡æ”¾ç½®ä¹¦æ¶ã€ç›‘æ§ä¹¦æ¶è¿™äº›æˆæœ¬ã€‚å¦åˆ™å¦‚æœæ˜¯ç›²ç›®ç…§æ¬ï¼Œã€Œå¬è¯´è€èµµå®¶ä¹°äº†ä¹¦æ¶ï¼Œå’±ä»¬å®¶ä¹Ÿä¹°ä¸€ä¸ªã€ï¼Œä¹°å›æ¥å´æ²¡ä»€ä¹ˆç”¨ï¼Œåªæ˜¯è®©æ­¥éª¤å˜å¤šäº†ï¼Œè¿˜ä¸å¦‚ç›´æ¥æŠŠä¹¦é€’ç»™å¯¹æ–¹å‘¢ï¼Œé‚£å°±ä¸å¯¹äº†ã€‚



**å¼•è¨€**
* ä½ æ˜¯å¦é‡åˆ°è¿‡ä¸¤ä¸ªï¼ˆå¤šä¸ªï¼‰ç³»ç»Ÿé—´éœ€è¦é€šè¿‡å®šæ—¶ä»»åŠ¡æ¥åŒæ­¥æŸäº›æ•°æ®ï¼Ÿä½ æ˜¯å¦åœ¨ä¸ºå¼‚æ„ç³»ç»Ÿçš„ä¸åŒè¿›ç¨‹é—´ç›¸äº’è°ƒç”¨ã€é€šè®¯çš„é—®é¢˜è€Œè‹¦æ¼ã€æŒ£æ‰ï¼Ÿå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œæ¶ˆæ¯æœåŠ¡è®©ä½ å¯ä»¥å¾ˆè½»æ¾åœ°è§£å†³è¿™äº›é—®é¢˜ã€‚
* æ¶ˆæ¯æœåŠ¡æ“…é•¿äºè§£å†³å¤šç³»ç»Ÿã€å¼‚æ„ç³»ç»Ÿé—´çš„æ•°æ®äº¤æ¢ï¼ˆæ¶ˆæ¯é€šçŸ¥/é€šè®¯ï¼‰é—®é¢˜ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠå®ƒç”¨äºç³»ç»Ÿé—´æœåŠ¡çš„ç›¸äº’è°ƒç”¨ï¼ˆRPCï¼‰ã€‚æœ¬æ–‡å°†è¦ä»‹ç»çš„RabbitMQå°±æ˜¯å½“å‰æœ€ä¸»æµçš„æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹ä¸€ã€‚




## äºŒã€RabbitMQç®€ä»‹

* AMQPï¼Œå³Advanced Message Queuing Protocolï¼Œé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚æ¶ˆæ¯ä¸­é—´ä»¶ä¸»è¦ç”¨äºç»„ä»¶ä¹‹é—´çš„è§£è€¦ï¼Œæ¶ˆæ¯çš„å‘é€è€…æ— éœ€çŸ¥é“æ¶ˆæ¯ä½¿ç”¨è€…çš„å­˜åœ¨ï¼Œåä¹‹äº¦ç„¶ã€‚
* AMQPçš„ä¸»è¦ç‰¹å¾æ˜¯é¢å‘æ¶ˆæ¯ã€é˜Ÿåˆ—ã€è·¯ç”±ï¼ˆåŒ…æ‹¬ç‚¹å¯¹ç‚¹å’Œå‘å¸ƒ/è®¢é˜…ï¼‰ã€å¯é æ€§ã€å®‰å…¨ã€‚
* RabbitMQæ˜¯ä¸€ä¸ªå¼€æºçš„AMQPå®ç°ï¼ŒæœåŠ¡å™¨ç«¯ç”¨Erlangè¯­è¨€ç¼–å†™ï¼Œæ”¯æŒå¤šç§å®¢æˆ·ç«¯ï¼Œå¦‚ï¼šPythonã€Rubyã€.NETã€Javaã€JMSã€Cã€PHPã€ActionScriptã€XMPPã€STOMPç­‰ï¼Œæ”¯æŒAJAXã€‚ç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜å‚¨è½¬å‘æ¶ˆæ¯ï¼Œåœ¨æ˜“ç”¨æ€§ã€æ‰©å±•æ€§ã€é«˜å¯ç”¨æ€§ç­‰æ–¹é¢è¡¨ç°ä¸ä¿—ã€‚
* ä¸‹é¢å°†é‡ç‚¹ä»‹ç»RabbitMQä¸­çš„ä¸€äº›åŸºç¡€æ¦‚å¿µï¼Œäº†è§£äº†è¿™äº›æ¦‚å¿µï¼Œæ˜¯ä½¿ç”¨å¥½RabbitMQçš„åŸºç¡€ã€‚
* ConnectionFactoryã€Connectionã€Channelï¼šConnectionFactoryã€Connectionã€Channeléƒ½æ˜¯RabbitMQå¯¹å¤–æä¾›çš„APIä¸­æœ€åŸºæœ¬çš„å¯¹è±¡ã€‚Connectionæ˜¯RabbitMQçš„socketé“¾æ¥ï¼Œå®ƒå°è£…äº†socketåè®®ç›¸å…³éƒ¨åˆ†é€»è¾‘ã€‚ConnectionFactoryä¸ºConnectionçš„åˆ¶é€ å·¥å‚ã€‚
* Channelæ˜¯æˆ‘ä»¬ä¸RabbitMQæ‰“äº¤é“çš„æœ€é‡è¦çš„ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¤§éƒ¨åˆ†çš„ä¸šåŠ¡æ“ä½œæ˜¯åœ¨Channelè¿™ä¸ªæ¥å£ä¸­å®Œæˆçš„ï¼ŒåŒ…æ‹¬å®šä¹‰Queueã€å®šä¹‰Exchangeã€ç»‘å®šQueueä¸Exchangeã€å‘å¸ƒæ¶ˆæ¯ç­‰ã€‚
* Queue(é˜Ÿåˆ—)ï¼šQueueï¼ˆé˜Ÿåˆ—ï¼‰æ˜¯RabbitMQçš„å†…éƒ¨å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨æ¶ˆæ¯ã€‚RabbitMQä¸­çš„æ¶ˆæ¯éƒ½åªèƒ½å­˜å‚¨åœ¨Queueä¸­ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯å¹¶æœ€ç»ˆæŠ•é€’åˆ°Queueä¸­ï¼Œæ¶ˆè´¹è€…å¯ä»¥ä»Queueä¸­è·å–æ¶ˆæ¯å¹¶æ¶ˆè´¹ã€‚å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…åŒä¸€ä¸ªQueueï¼Œè¿™æ—¶Queueä¸­çš„æ¶ˆæ¯ä¼šè¢«å¹³å‡åˆ†æ‘Šç»™å¤šä¸ªæ¶ˆè´¹è€…è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æ”¶åˆ°æ‰€æœ‰çš„æ¶ˆæ¯å¹¶å¤„ç†ã€‚
* Message acknowledgment(æ¶ˆæ¯å›æ‰§)ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ¶ˆè´¹è€…æ”¶åˆ°Queueä¸­çš„æ¶ˆæ¯ï¼Œä½†æ²¡æœ‰å¤„ç†å®Œæˆå°±å®•æœºï¼ˆæˆ–å‡ºç°å…¶ä»–æ„å¤–ï¼‰çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹å°±å¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œæˆ‘ä»¬å¯ä»¥è¦æ±‚æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹å®Œæ¶ˆæ¯åå‘é€ä¸€ä¸ªå›æ‰§ç»™RabbitMQï¼ŒRabbitMQæ”¶åˆ°æ¶ˆæ¯å›æ‰§ï¼ˆMessage acknowledgmentï¼‰åæ‰å°†è¯¥æ¶ˆæ¯ä»Queueä¸­ç§»é™¤ï¼›å¦‚æœRabbitMQæ²¡æœ‰æ”¶åˆ°å›æ‰§å¹¶æ£€æµ‹åˆ°æ¶ˆè´¹è€…çš„RabbitMQè¿æ¥æ–­å¼€ï¼Œåˆ™RabbitMQä¼šå°†è¯¥æ¶ˆæ¯å‘é€ç»™å…¶ä»–æ¶ˆè´¹è€…ï¼ˆå¦‚æœå­˜åœ¨å¤šä¸ªæ¶ˆè´¹è€…ï¼‰è¿›è¡Œå¤„ç†ã€‚è¿™é‡Œä¸å­˜åœ¨timeoutæ¦‚å¿µï¼Œä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯æ—¶é—´å†é•¿ä¹Ÿä¸ä¼šå¯¼è‡´è¯¥æ¶ˆæ¯è¢«å‘é€ç»™å…¶ä»–æ¶ˆè´¹è€…ï¼Œé™¤éå®ƒçš„RabbitMQè¿æ¥æ–­å¼€ã€‚
* è¿™é‡Œä¼šäº§ç”Ÿå¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬çš„å¼€å‘äººå‘˜åœ¨å¤„ç†å®Œä¸šåŠ¡é€»è¾‘åï¼Œå¿˜è®°å‘é€å›æ‰§ç»™RabbitMQï¼Œè¿™å°†ä¼šå¯¼è‡´ä¸¥é‡çš„bugâ€”â€”Queueä¸­å †ç§¯çš„æ¶ˆæ¯ä¼šè¶Šæ¥è¶Šå¤šï¼›æ¶ˆè´¹è€…é‡å¯åä¼šé‡å¤æ¶ˆè´¹è¿™äº›æ¶ˆæ¯å¹¶é‡å¤æ‰§è¡Œä¸šåŠ¡é€»è¾‘â€¦
* Message durability(æ¶ˆæ¯æŒä¹…åŒ–)ï¼šå¦‚æœæˆ‘ä»¬å¸Œæœ›å³ä½¿åœ¨RabbitMQæœåŠ¡é‡å¯çš„æƒ…å†µä¸‹ï¼Œä¹Ÿä¸ä¼šä¸¢å¤±æ¶ˆæ¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†Queueä¸Messageéƒ½è®¾ç½®ä¸ºå¯æŒä¹…åŒ–çš„ï¼ˆdurableï¼‰ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹æˆ‘ä»¬çš„RabbitMQæ¶ˆæ¯ä¸ä¼šä¸¢å¤±ã€‚ä½†ä¾ç„¶è§£å†³ä¸äº†å°æ¦‚ç‡ä¸¢å¤±äº‹ä»¶çš„å‘ç”Ÿï¼ˆæ¯”å¦‚RabbitMQæœåŠ¡å™¨å·²ç»æ¥æ”¶åˆ°ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œä½†è¿˜æ²¡æ¥å¾—åŠæŒä¹…åŒ–è¯¥æ¶ˆæ¯æ—¶RabbitMQæœåŠ¡å™¨å°±æ–­ç”µäº†ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å¯¹è¿™ç§å°æ¦‚ç‡äº‹ä»¶ä¹Ÿè¦ç®¡ç†èµ·æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦ç”¨åˆ°äº‹åŠ¡ã€‚ç”±äºè¿™é‡Œä»…ä¸ºRabbitMQçš„ç®€å•ä»‹ç»ï¼Œæ‰€ä»¥è¿™é‡Œå°†ä¸è®²è§£RabbitMQç›¸å…³çš„äº‹åŠ¡ã€‚
* Prefetch count(é¢„è½½å…¥æ•°)ï¼šå‰é¢æˆ‘ä»¬è®²åˆ°å¦‚æœæœ‰å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶è®¢é˜…åŒä¸€ä¸ªQueueä¸­çš„æ¶ˆæ¯ï¼ŒQueueä¸­çš„æ¶ˆæ¯ä¼šè¢«å¹³æ‘Šç»™å¤šä¸ªæ¶ˆè´¹è€…ã€‚è¿™æ—¶å¦‚æœæ¯ä¸ªæ¶ˆæ¯çš„å¤„ç†æ—¶é—´ä¸åŒï¼Œå°±æœ‰å¯èƒ½ä¼šå¯¼è‡´æŸäº›æ¶ˆè´¹è€…ä¸€ç›´åœ¨å¿™ï¼Œè€Œå¦å¤–ä¸€äº›æ¶ˆè´¹è€…å¾ˆå¿«å°±å¤„ç†å®Œæ‰‹å¤´å·¥ä½œå¹¶ä¸€ç›´ç©ºé—²çš„æƒ…å†µã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®prefetchCountæ¥é™åˆ¶Queueæ¯æ¬¡å‘é€ç»™æ¯ä¸ªæ¶ˆè´¹è€…çš„æ¶ˆæ¯æ•°ï¼Œæ¯”å¦‚æˆ‘ä»¬è®¾ç½®prefetchCount=1ï¼Œåˆ™Queueæ¯æ¬¡ç»™æ¯ä¸ªæ¶ˆè´¹è€…å‘é€ä¸€æ¡æ¶ˆæ¯ï¼›æ¶ˆè´¹è€…å¤„ç†å®Œè¿™æ¡æ¶ˆæ¯åQueueä¼šå†ç»™è¯¥æ¶ˆè´¹è€…å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚
* Exchange(äº¤æ¢å™¨)ï¼šåœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬çœ‹åˆ°ç”Ÿäº§è€…å°†æ¶ˆæ¯æŠ•é€’åˆ°Queueä¸­ï¼Œå®é™…ä¸Šè¿™åœ¨RabbitMQä¸­è¿™ç§äº‹æƒ…æ°¸è¿œéƒ½ä¸ä¼šå‘ç”Ÿã€‚å®é™…çš„æƒ…å†µæ˜¯ï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°Exchangeï¼Œç”±Exchangeå°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªQueueä¸­ï¼ˆæˆ–è€…ä¸¢å¼ƒï¼‰ã€‚
* routing key(è·¯ç”±key):ç”Ÿäº§è€…åœ¨å°†æ¶ˆæ¯å‘é€ç»™Exchangeçš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ªrouting keyï¼Œæ¥æŒ‡å®šè¿™ä¸ªæ¶ˆæ¯çš„è·¯ç”±è§„åˆ™ï¼Œè€Œè¿™ä¸ªrouting keyéœ€è¦ä¸Exchange TypeåŠbinding keyè”åˆä½¿ç”¨æ‰èƒ½æœ€ç»ˆç”Ÿæ•ˆã€‚
* åœ¨Exchange Typeä¸binding keyå›ºå®šçš„æƒ…å†µä¸‹ï¼ˆåœ¨æ­£å¸¸ä½¿ç”¨æ—¶ä¸€èˆ¬è¿™äº›å†…å®¹éƒ½æ˜¯å›ºå®šé…ç½®å¥½çš„ï¼‰ï¼Œæˆ‘ä»¬çš„ç”Ÿäº§è€…å°±å¯ä»¥åœ¨å‘é€æ¶ˆæ¯ç»™Exchangeæ—¶ï¼Œé€šè¿‡æŒ‡å®šrouting keyæ¥å†³å®šæ¶ˆæ¯æµå‘å“ªé‡Œã€‚
* RabbitMQä¸ºrouting keyè®¾å®šçš„é•¿åº¦é™åˆ¶ä¸º255 bytesã€‚
* Binding(ç»‘å®š):RabbitMQä¸­é€šè¿‡Bindingå°†Exchangeä¸Queueå…³è”èµ·æ¥ï¼Œè¿™æ ·RabbitMQå°±çŸ¥é“å¦‚ä½•æ­£ç¡®åœ°å°†æ¶ˆæ¯è·¯ç”±åˆ°æŒ‡å®šçš„Queueäº†ã€‚
* Binding key(ç»‘å®škey):åœ¨ç»‘å®šï¼ˆBindingï¼‰Exchangeä¸Queueçš„åŒæ—¶ï¼Œä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ªbinding key(å¯ä»¥æœ‰å¤šä¸ªBinding key)ï¼›æ¶ˆè´¹è€…å°†æ¶ˆæ¯å‘é€ç»™Exchangeæ—¶ï¼Œä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ªrouting keyï¼›å½“binding keyä¸routing keyç›¸åŒ¹é…æ—¶ï¼Œæ¶ˆæ¯å°†ä¼šè¢«è·¯ç”±åˆ°å¯¹åº”çš„Queueä¸­ã€‚åœ¨ç»‘å®šå¤šä¸ªQueueåˆ°åŒä¸€ä¸ªExchangeçš„æ—¶å€™ï¼Œè¿™äº›Bindingå…è®¸ä½¿ç”¨ç›¸åŒçš„binding keyã€‚binding key å¹¶ä¸æ˜¯åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½ç”Ÿæ•ˆï¼Œå®ƒä¾èµ–äºExchange Typeï¼Œæ¯”å¦‚fanoutç±»å‹çš„Exchangeå°±ä¼šæ— è§†binding keyï¼Œè€Œæ˜¯å°†æ¶ˆæ¯è·¯ç”±åˆ°æ‰€æœ‰ç»‘å®šåˆ°è¯¥Exchangeçš„Queueã€‚


**Exchange Types(äº¤æ¢å™¨ç±»å‹)**
* RabbitMQå¸¸ç”¨çš„Exchange Typeæœ‰fanoutã€directã€topicã€headersè¿™å››ç§ï¼š
* fanout:fanoutç±»å‹çš„Exchangeè·¯ç”±è§„åˆ™éå¸¸ç®€å•ï¼Œå®ƒä¼šæŠŠæ‰€æœ‰å‘é€åˆ°è¯¥Exchangeçš„æ¶ˆæ¯è·¯ç”±åˆ°æ‰€æœ‰ä¸å®ƒç»‘å®šçš„Queueä¸­ã€‚
* direct:directç±»å‹çš„Exchangeè·¯ç”±è§„åˆ™ä¹Ÿå¾ˆç®€å•ï¼Œå®ƒä¼šæŠŠæ¶ˆæ¯è·¯ç”±åˆ°é‚£äº›binding keyä¸routing keyå®Œå…¨åŒ¹é…çš„Queueä¸­ã€‚
* topic:å‰é¢è®²åˆ°directç±»å‹çš„Exchangeè·¯ç”±è§„åˆ™æ˜¯å®Œå…¨åŒ¹é…binding keyä¸routing keyï¼Œä½†è¿™ç§ä¸¥æ ¼çš„åŒ¹é…æ–¹å¼åœ¨å¾ˆå¤šæƒ…å†µä¸‹ä¸èƒ½æ»¡è¶³å®é™…ä¸šåŠ¡éœ€æ±‚ã€‚topicç±»å‹çš„Exchangeåœ¨åŒ¹é…è§„åˆ™ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œå®ƒä¸directç±»å‹çš„Exchageç›¸ä¼¼ï¼Œä¹Ÿæ˜¯å°†æ¶ˆæ¯è·¯ç”±åˆ°binding keyä¸routing keyç›¸åŒ¹é…çš„Queueä¸­ï¼Œä½†è¿™é‡Œçš„åŒ¹é…è§„åˆ™æœ‰äº›ä¸åŒï¼Œå®ƒçº¦å®šï¼š
* routing keyä¸ºä¸€ä¸ªå¥ç‚¹å·â€œ. â€åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ˆæˆ‘ä»¬å°†è¢«å¥ç‚¹å·â€œ. â€åˆ†éš”å¼€çš„æ¯ä¸€æ®µç‹¬ç«‹çš„å­—ç¬¦ä¸²ç§°ä¸ºä¸€ä¸ªå•è¯ï¼‰ï¼Œå¦‚â€œstock.usd.nyseâ€ã€â€œnyse.vmwâ€ã€â€œquick.orange.rabbitâ€
* binding keyä¸routing keyä¸€æ ·ä¹Ÿæ˜¯å¥ç‚¹å·â€œ. â€åˆ†éš”çš„å­—ç¬¦ä¸²
* binding keyä¸­å¯ä»¥å­˜åœ¨ä¸¤ç§ç‰¹æ®Šå­—ç¬¦â€œ*â€ä¸â€œ#â€ï¼Œç”¨äºåšæ¨¡ç³ŠåŒ¹é…ï¼Œå…¶ä¸­â€œ*â€ç”¨äºåŒ¹é…ä¸€ä¸ªå•è¯ï¼Œâ€œ#â€ç”¨äºåŒ¹é…å¤šä¸ªå•è¯ï¼ˆå¯ä»¥æ˜¯é›¶ä¸ªï¼‰
* headers:headersç±»å‹çš„Exchangeä¸ä¾èµ–äºrouting keyä¸binding keyçš„åŒ¹é…è§„åˆ™æ¥è·¯ç”±æ¶ˆæ¯ï¼Œè€Œæ˜¯æ ¹æ®å‘é€çš„æ¶ˆæ¯å†…å®¹ä¸­çš„headerså±æ€§è¿›è¡ŒåŒ¹é…ã€‚åœ¨ç»‘å®šQueueä¸Exchangeæ—¶æŒ‡å®šä¸€ç»„é”®å€¼å¯¹ï¼›å½“æ¶ˆæ¯å‘é€åˆ°Exchangeæ—¶ï¼ŒRabbitMQä¼šå–åˆ°è¯¥æ¶ˆæ¯çš„headersï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªé”®å€¼å¯¹çš„å½¢å¼ï¼‰ï¼Œå¯¹æ¯”å…¶ä¸­çš„é”®å€¼å¯¹æ˜¯å¦å®Œå…¨åŒ¹é…Queueä¸Exchangeç»‘å®šæ—¶æŒ‡å®šçš„é”®å€¼å¯¹ï¼›å¦‚æœå®Œå…¨åŒ¹é…åˆ™æ¶ˆæ¯ä¼šè·¯ç”±åˆ°è¯¥Queueï¼Œå¦åˆ™ä¸ä¼šè·¯ç”±åˆ°è¯¥Queueã€‚è¯¥ç±»å‹çš„Exchangeæ²¡æœ‰ç”¨åˆ°è¿‡ï¼ˆä¸è¿‡ä¹Ÿåº”è¯¥å¾ˆæœ‰ç”¨æ­¦ä¹‹åœ°ï¼‰ï¼Œæ‰€ä»¥ä¸åšä»‹ç»ã€‚

**RPC**
* MQæœ¬èº«æ˜¯åŸºäºå¼‚æ­¥çš„æ¶ˆæ¯å¤„ç†ï¼Œå‰é¢çš„ç¤ºä¾‹ä¸­æ‰€æœ‰çš„ç”Ÿäº§è€…ï¼ˆPï¼‰å°†æ¶ˆæ¯å‘é€åˆ°RabbitMQåä¸ä¼šçŸ¥é“æ¶ˆè´¹è€…ï¼ˆCï¼‰å¤„ç†æˆåŠŸæˆ–è€…å¤±è´¥ï¼ˆç”šè‡³è¿æœ‰æ²¡æœ‰æ¶ˆè´¹è€…æ¥å¤„ç†è¿™æ¡æ¶ˆæ¯éƒ½ä¸çŸ¥é“ï¼‰ã€‚
* ä½†å®é™…çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¾ˆå¯èƒ½éœ€è¦ä¸€äº›åŒæ­¥å¤„ç†ï¼Œéœ€è¦åŒæ­¥ç­‰å¾…æœåŠ¡ç«¯å°†æˆ‘çš„æ¶ˆæ¯å¤„ç†å®Œæˆåå†è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ã€‚è¿™ç›¸å½“äºRPCï¼ˆRemote Procedure Callï¼Œè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰ã€‚åœ¨RabbitMQä¸­ä¹Ÿæ”¯æŒRPCã€‚
* RabbitMQä¸­å®ç°RPCçš„æœºåˆ¶æ˜¯ï¼š
* å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ˆæ¶ˆæ¯ï¼‰æ—¶ï¼Œåœ¨æ¶ˆæ¯çš„å±æ€§ï¼ˆMessagePropertiesï¼Œåœ¨AMQPåè®®ä¸­å®šä¹‰äº†14ä¸­propertiesï¼Œè¿™äº›å±æ€§ä¼šéšç€æ¶ˆæ¯ä¸€èµ·å‘é€ï¼‰ä¸­è®¾ç½®ä¸¤ä¸ªå€¼replyToï¼ˆä¸€ä¸ªQueueåç§°ï¼Œç”¨äºå‘Šè¯‰æœåŠ¡å™¨å¤„ç†å®Œæˆåå°†é€šçŸ¥æˆ‘çš„æ¶ˆæ¯å‘é€åˆ°è¿™ä¸ªQueueä¸­ï¼‰å’ŒcorrelationIdï¼ˆæ­¤æ¬¡è¯·æ±‚çš„æ ‡è¯†å·ï¼ŒæœåŠ¡å™¨å¤„ç†å®Œæˆåéœ€è¦å°†æ­¤å±æ€§è¿”è¿˜ï¼Œå®¢æˆ·ç«¯å°†æ ¹æ®è¿™ä¸ªidäº†è§£å“ªæ¡è¯·æ±‚è¢«æˆåŠŸæ‰§è¡Œäº†æˆ–æ‰§è¡Œå¤±è´¥ï¼‰

* æœåŠ¡å™¨ç«¯æ”¶åˆ°æ¶ˆæ¯å¹¶å¤„ç†
* æœåŠ¡å™¨ç«¯å¤„ç†å®Œæ¶ˆæ¯åï¼Œå°†ç”Ÿæˆä¸€æ¡åº”ç­”æ¶ˆæ¯åˆ°replyToæŒ‡å®šçš„Queueï¼ŒåŒæ—¶å¸¦ä¸ŠcorrelationIdå±æ€§
* å®¢æˆ·ç«¯ä¹‹å‰å·²è®¢é˜…replyToæŒ‡å®šçš„Queueï¼Œä»ä¸­æ”¶åˆ°æœåŠ¡å™¨çš„åº”ç­”æ¶ˆæ¯åï¼Œæ ¹æ®å…¶ä¸­çš„correlationIdå±æ€§åˆ†æå“ªæ¡è¯·æ±‚è¢«æ‰§è¡Œäº†ï¼Œæ ¹æ®æ‰§è¡Œç»“æœè¿›è¡Œåç»­ä¸šåŠ¡å¤„ç†

**RabbitMQå¯¹è±¡ç±»å‹ï¼š**
* RabbitMQ Serverï¼š ä¹Ÿå«broker serverï¼Œæ˜¯ä¸€ç§ä¼ è¾“æœåŠ¡ã€‚ä»–çš„è§’è‰²å°±æ˜¯ç»´æŠ¤ä¸€æ¡ä»Produceråˆ°Consumerçš„è·¯çº¿ï¼Œä¿è¯æ•°æ®èƒ½å¤ŸæŒ‰ç…§æŒ‡å®šçš„æ–¹å¼è¿›è¡Œä¼ è¾“ã€‚ä½†æ˜¯è¿™ä¸ªä¿è¯ä¹Ÿä¸æ˜¯100%çš„ä¿è¯ï¼Œä½†æ˜¯å¯¹äºæ™®é€šçš„åº”ç”¨æ¥è¯´è¿™å·²ç»è¶³å¤Ÿäº†ã€‚å½“ç„¶å¯¹äºå•†ä¸šç³»ç»Ÿæ¥è¯´ï¼Œå¯ä»¥å†åšä¸€å±‚æ•°æ®ä¸€è‡´æ€§çš„guardï¼Œå°±å¯ä»¥å½»åº•ä¿è¯ç³»ç»Ÿçš„ä¸€è‡´æ€§äº†ã€‚
* Producerï¼šæ•°æ®çš„å‘é€æ–¹ï¼Œä¸€ä¸ªMessageæœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼špayloadï¼ˆæœ‰æ•ˆè½½è·ï¼‰å’Œlabelï¼ˆæ ‡ç­¾ï¼‰ã€‚payloadé¡¾åæ€ä¹‰å°±æ˜¯ä¼ è¾“çš„æ•°æ®ã€‚labelæ˜¯exchangeçš„åå­—æˆ–è€…è¯´æ˜¯ä¸€ä¸ªtagï¼Œå®ƒæè¿°äº†payloadï¼Œè€Œä¸”RabbitMQä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªlabelæ¥å†³å®šæŠŠè¿™ä¸ªMessageå‘ç»™å“ªä¸ªConsumerã€‚AMQPä»…ä»…æè¿°äº†labelï¼Œè€ŒRabbitMQå†³å®šäº†å¦‚ä½•ä½¿ç”¨è¿™ä¸ªlabelçš„è§„åˆ™ã€‚
* Consumerï¼šæ•°æ®çš„æ¥æ”¶æ–¹ã€‚æŠŠqueueæ¯”ä½œæ˜¯ä¸€ä¸ªæœ‰åå­—çš„é‚®ç®±ã€‚å½“æœ‰Messageåˆ°è¾¾æŸä¸ªé‚®ç®±åï¼ŒRabbitMQæŠŠå®ƒå‘é€ç»™å®ƒçš„æŸä¸ªè®¢é˜…è€…å³Consumerã€‚å½“ç„¶å¯èƒ½ä¼šæŠŠåŒä¸€ä¸ªMessageå‘é€ç»™å¾ˆå¤šçš„Consumerã€‚åœ¨è¿™ä¸ªMessageä¸­ï¼Œåªæœ‰payloadï¼Œlabelå·²ç»è¢«åˆ æ‰äº†ã€‚å¯¹äºConsumeræ¥è¯´ï¼Œå®ƒæ˜¯ä¸çŸ¥é“è°å‘é€çš„è¿™ä¸ªä¿¡æ¯çš„ã€‚å°±æ˜¯åè®®æœ¬èº«ä¸æ”¯æŒã€‚ä½†æ˜¯å½“ç„¶äº†å¦‚æœProducerå‘é€çš„payloadåŒ…å«äº†Producerçš„ä¿¡æ¯å°±å¦å½“åˆ«è®ºäº†ã€‚
* Connectionï¼š å°±æ˜¯ä¸€ä¸ªTCPçš„è¿æ¥ã€‚Producerå’ŒConsumeréƒ½æ˜¯é€šè¿‡TCPè¿æ¥åˆ°RabbitMQ Serverçš„ã€‚ä»¥åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºçš„èµ·å§‹å¤„å°±æ˜¯å»ºç«‹è¿™ä¸ªTCPè¿æ¥ã€‚
* Channelsï¼š è™šæ‹Ÿè¿æ¥ã€‚å®ƒå»ºç«‹åœ¨ä¸Šè¿°çš„TCPè¿æ¥ä¸­ã€‚æ•°æ®æµåŠ¨éƒ½æ˜¯åœ¨Channelä¸­è¿›è¡Œçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€èˆ¬æƒ…å†µæ˜¯ç¨‹åºèµ·å§‹å»ºç«‹TCPè¿æ¥ï¼Œç¬¬äºŒæ­¥å°±æ˜¯å»ºç«‹è¿™ä¸ªChannelã€‚
* é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä½¿ç”¨Channelï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨TCPè¿æ¥ï¼Ÿ
* å¯¹äºOSæ¥è¯´ï¼Œå»ºç«‹å’Œå…³é—­TCPè¿æ¥æ˜¯æœ‰ä»£ä»·çš„ï¼Œé¢‘ç¹çš„å»ºç«‹å…³é—­TCPè¿æ¥å¯¹äºç³»ç»Ÿçš„æ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ï¼Œè€Œä¸”TCPçš„è¿æ¥æ•°ä¹Ÿæœ‰é™åˆ¶ï¼Œè¿™ä¹Ÿé™åˆ¶äº†ç³»ç»Ÿå¤„ç†é«˜å¹¶å‘çš„èƒ½åŠ›ã€‚ä½†æ˜¯ï¼Œåœ¨TCPè¿æ¥ä¸­å»ºç«‹Channelæ˜¯æ²¡æœ‰ä¸Šè¿°ä»£ä»·çš„ã€‚å¯¹äºProduceræˆ–è€…Consumeræ¥è¯´ï¼Œå¯ä»¥å¹¶å‘çš„ä½¿ç”¨å¤šä¸ªChannelè¿›è¡ŒPublishæˆ–è€…Receiveã€‚æœ‰å®éªŒè¡¨æ˜ï¼Œ1sçš„æ•°æ®å¯ä»¥Publish10Kçš„æ•°æ®åŒ…ã€‚å½“ç„¶å¯¹äºä¸åŒçš„ç¡¬ä»¶ç¯å¢ƒï¼Œä¸åŒçš„æ•°æ®åŒ…å¤§å°è¿™ä¸ªæ•°æ®è‚¯å®šä¸ä¸€æ ·ï¼Œä½†æ˜¯æˆ‘åªæƒ³è¯´æ˜ï¼Œå¯¹äºæ™®é€šçš„Consumeræˆ–è€…Produceræ¥è¯´ï¼Œè¿™å·²ç»è¶³å¤Ÿäº†ã€‚å¦‚æœä¸å¤Ÿç”¨ï¼Œä½ è€ƒè™‘çš„åº”è¯¥æ˜¯å¦‚ä½•ç»†åŒ–splitä½ çš„è®¾è®¡ã€‚

**è§£è€¦**
* æ¶ˆæ¯ä¼ è¾“è¿‡ç¨‹ä¸­ä¿å­˜æ¶ˆæ¯çš„å®¹å™¨ï¼Œé˜Ÿåˆ—çš„ä¸»è¦ç›®çš„ï¼šæ˜¯æä¾›è·¯ç”±å¹¶ä¿è¯æ¶ˆæ¯çš„ä¼ é€’å¦‚æœå‘é€æ¶ˆæ¯æ—¶æ¥æ”¶è€…ä¸å¯ç”¨ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¼šä¿ç•™æ¶ˆæ¯ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼Œå½“ç„¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¿å­˜æ¶ˆæ¯ä¹Ÿæ˜¯æœ‰æœŸé™çš„ã€‚
* PTP:ç‚¹å¯¹ç‚¹ï¼Œä¸€ä¸ªæ¶ˆæ¯åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹åä¼šå‘é€ç¡®è®¤æ¶ˆæ¯ç»™é˜Ÿåˆ—ã€‚
* publish/subscribe:å‘å¸ƒå’Œè®¢é˜…ï¼Œæ¶ˆè´¹è€…éœ€è¦è®¢é˜…ä¸»é¢˜ï¼Œåˆ†æŒä¹…è®¢é˜…å’ŒéæŒä¹…è®¢é˜…ï¼Œä¸€ä¸ªæ¶ˆæ¯æœ‰å¤šä¿¡è®¢é˜…è€…ï¼Œå®¢æˆ·ç«¯åªæœ‰è®¢é˜…åæ‰èƒ½æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œ
* æŒä¹…è®¢é˜…ï¼šè®¢é˜…å…³ç³»å»ºç«‹åï¼Œæ¶ˆæ¯å°±ä¸ä¼šæ¶ˆå¤±ï¼Œä¸ç®¡è®¢é˜…è€…æ˜¯å¦åœ¨çº¿
* éæŒä¹…è®¢é˜…ï¼šè®¢é˜…è€…ä¸ºäº†æ¥æ”¶æ¶ˆæ¯ï¼Œå¿…é¡»ä¸€ç›´åœ¨çº¿ï¼Œå¦åˆ™æ¶ˆæ¯ä¼šæ¶ˆå¤±

**ç®€å•æ¨¡å¼ï¼ˆä¸€å¯¹ä¸€ï¼‰**
* ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ç»™äº¤æ¢æœº
* äº¤æ¢æœºæ¥æ”¶æ¶ˆæ¯ï¼Œå¦‚æœäº¤æ¢æœºæ²¡æœ‰ç»‘å®šé˜Ÿåˆ—ï¼Œæ¶ˆæ¯æ‰”è¿›åƒåœ¾æ¡¶
* é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯ï¼Œå­˜å‚¨åœ¨å†…å­˜ï¼Œç­‰å¾…æ¶ˆè´¹è€…è¿æ¥ç›‘å¬è·å–æ¶ˆæ¯ï¼Œæ¶ˆè´¹æˆåŠŸåï¼Œè¿”å›ç¡®è®¤ã€‚
* ä¸€äº›åœºæ™¯ï¼šçŸ­ä¿¡ï¼ŒQQ

**å·¥ä½œæ¨¡å¼ï¼ˆä¸€å¯¹å¤šï¼‰ï¼š**
* ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€ç»™äº¤æ¢æœº
* äº¤æ¢æœºå‘é€ç»™ç»‘å®šçš„åç«¯é˜Ÿåˆ—
* ä¸€ä¸ªé˜Ÿåˆ—è¢«å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶ç›‘å¬ï¼Œå½¢æˆæ¶ˆæ¯çš„äº‰æŠ¢ç»“æ„ï¼šæ ¹æ®æ¶ˆè´¹è€…æ‰€åœ¨çš„ç³»ç»Ÿçš„ç©ºé—²ã€æ€§èƒ½äº‰æŠ¢é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯
* ä¸€äº›åœºæ™¯ï¼šæŠ¢çº¢åŒ…

**å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼š**
* äº¤æ¢æœºå®šä¹‰ç±»å‹ä¸ºï¼šfanout
* äº¤æ¢æœºç»‘å®šå¤šä¸ªé˜Ÿåˆ—
* ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€ç»™äº¤æ¢æœºï¼Œäº¤æ¢æœºå¤åˆ¶åŒæ­¥æ¶ˆæ¯åˆ°åç«¯æ‰€æœ‰çš„é˜Ÿåˆ—ä¸­
* ä¸€äº›åœºæ™¯ï¼šé‚®ä»¶ç¾¤å‘

**è·¯ç”±æ¨¡å¼ï¼š**
* äº¤æ¢æœºå®šä¹‰ç±»å‹ä¸ºï¼šdirect
* äº¤æ¢æœºç»‘å®šå¤šä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ç»‘å®šäº¤æ¢æœºæ—¶ï¼Œç»™äº¤æ¢æœºæä¾›äº†ä¸€ä¸ªroutingkeyï¼ˆè·¯ç”±keyï¼‰
* å‘å¸ƒè®¢é˜…æ—¶ï¼Œæ‰€æœ‰fanoutç±»å‹çš„äº¤æ¢æœºç»‘å®šåç«¯é˜Ÿåˆ—ç”¨çš„è·¯ç”±keyéƒ½æ˜¯â€œâ€ï¼›åœ¨è·¯ç”±æ¨¡å¼ä¸­éœ€è¦ç»‘å®šé˜Ÿåˆ—æ—¶æä¾›å½“å‰é˜Ÿåˆ—çš„å…·ä½“è·¯ç”±key
* ä¸€äº›åœºæ™¯ï¼šé”™è¯¯æ¶ˆæ¯çš„æ¥æ”¶å’Œæç¤º

**ä¸»é¢˜æ¨¡å¼ï¼š**
* äº¤æ¢æœºå®šä¹‰ç±»å‹ä¸ºï¼štopic
* äº¤æ¢æœºç»‘å®šå¤šä¸ªé˜Ÿåˆ—ï¼Œä¸è·¯ç”±æ¨¡å¼éå¸¸ç›¸ä¼¼ï¼Œåšåˆ°æŒ‰ç±»åˆ’åˆ†æ¶ˆæ¯
* è·¯ç”±keyé˜Ÿåˆ—ç»‘å®šçš„é€šé…ç¬¦å¦‚ä¸‹ï¼š#è¡¨ç¤ºä»»æ„å­—ç¬¦ä¸²ï¼Œ*è¡¨ç¤ºæ²¡æœ‰ç‰¹æ®Šç¬¦å·ï¼ˆå•è¯ï¼‰çš„å­—ç¬¦ä¸²





## ä¸‰ã€RabbitMQéƒ¨ç½²

RabbitMQæ¨¡å¼å¤§æ¦‚åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§:
1. å•ä¸€æ¨¡å¼ã€‚
2. æ™®é€šæ¨¡å¼(é»˜è®¤çš„é›†ç¾¤æ¨¡å¼)ã€‚
3. é•œåƒæ¨¡å¼(æŠŠéœ€è¦çš„é˜Ÿåˆ—åšæˆé•œåƒé˜Ÿåˆ—ï¼Œå­˜åœ¨äºå¤šä¸ªèŠ‚ç‚¹ï¼Œå±äºRabbiMQçš„HAæ–¹æ¡ˆï¼Œåœ¨å¯¹ä¸šåŠ¡å¯é æ€§è¦æ±‚è¾ƒé«˜çš„åœºåˆä¸­æ¯”è¾ƒé€‚ç”¨)ã€‚
è¦å®ç°é•œåƒæ¨¡å¼ï¼Œéœ€è¦å…ˆæ­å»ºä¸€ä¸ªæ™®é€šé›†ç¾¤æ¨¡å¼ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼çš„åŸºç¡€ä¸Šå†é…ç½®é•œåƒæ¨¡å¼ä»¥å®ç°é«˜å¯ç”¨ã€‚



### 3.1 å•ä¸€æ¨¡å¼éƒ¨ç½²

> å®‰è£…erlangç‰ˆæœ¬è¦å¤§äº21.6ï¼Œå› ä¸ºrabbitmq-server3.8éœ€è¦


```bash
# å®‰è£…Erlang,åˆ›å»ºErlangçš„yumæºï¼š
[root@node3 yum.repos.d]# cat rabbitmq-erlang.repo 
[rabbitmq-erlang]
name=rabbitmq-erlang
baseurl=https://mirrors.tuna.tsinghua.edu.cn/erlang-solutions/centos/7
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
gpgcheck=0
# åˆ›å»ºrabbitmqçš„yumæºï¼š
[root@node3 yum.repos.d]# cat rabbitmq.repo 
[bintray-rabbitmq-server]
name=bintray-rabbitmq-rpm
baseurl=https://dl.bintray.com/rabbitmq/rpm/rabbitmq-server/v3.8.x/el/7/
gpgcheck=0
repo_gpgcheck=0
enabled=1
[root@node2 yum.repos.d]# yum clean all 
[root@node2 yum.repos.d]# yum makecache
# å®‰è£…Erlangï¼š
sudo yum install -y erlang 			##--disablerepo=epel
# å®‰è£…å¯åŠ¨rabbitmq
# å¯¼å…¥å¯†é’¥ï¼š
rpm --import https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc
[root@node3 pki]# yum install -y rabbitmq-server 
[root@node3 pki]# systemctl start rabbitmq-server.service
#r abbitä¸­é…ç½®æ–‡ä»¶å¤¹ä¼šäº/etc/rabbitmq/,ä¸‹é¢æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œéƒ½éœ€è¦æ–°å»ºé…ç½®æ–‡ä»¶ã€‚rabbitmq.confæ˜¯ç”¨sysctlæ–°æ ¼å¼é£æ ¼ä¹¦å†™,rabbitmq.configæ˜¯ç”¨erlangè€æ ¼å¼ä¹¦å†™ã€‚å°±æ˜¯configåç¼€èŠ‚å°¾æ˜¯è€æ ¼å¼ï¼Œconfæ˜¯æ–°æ ¼å¼ï¼Œrabbitmq-env.confè¦åœ¨rabbitmq.confä¹‹å‰è¢«åŠ è½½ï¼Œå®ƒå…¶å®å°±æ˜¯é€šè¿‡linuxç¯å¢ƒå˜é‡æ¥å½±å“ç¨‹åºçš„è¡Œä¸ºï¼Œæ¯”å¦‚å¯ä»¥é€šè¿‡rabbitmq-env.confæŒ‡å®šæ¥ä¸‹æ¥è¦åŠ è½½çš„rabbitmq.confæ–‡ä»¶çš„ä½ç½®ã€‚
è¦è¦†ç›–RabbitMQé…ç½®æ–‡ä»¶çš„ä¸»è¦ä½ç½®ï¼Œè¯·ä½¿ç”¨RABBITMQ_CONFIG_FILE  ç¯å¢ƒå˜é‡ã€‚å°†.confç”¨ä½œæ–°æ ·å¼é…ç½®æ ¼å¼çš„æ–‡ä»¶æ‰©å±•åã€‚
æŸäº›é…ç½®è®¾ç½®ä¸å¯èƒ½æˆ–éš¾ä»¥ä½¿ç”¨sysctlæ ¼å¼è¿›è¡Œé…ç½®ã€‚è¿™æ ·ï¼Œå¯ä»¥ä½¿ç”¨Erlangæœ¯è¯­æ ¼å¼çš„å¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ˆä¸rabbitmq.configç›¸åŒï¼‰ã€‚è¯¥æ–‡ä»¶é€šå¸¸å‘½åä¸ºadvanced.configã€‚å®ƒå°†ä¸Rabbitmq.confä¸­æä¾›çš„é…ç½®åˆå¹¶ã€‚è¦è¦†ç›–é«˜çº§é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œè¯·ä½¿ç”¨RABBITMQ_ADVANCED_CONFIG_FILE ç¯å¢ƒå˜é‡ã€‚
# é…ç½®æ–‡ä»¶æ¡ˆä¾‹èŒƒæœ¬é“¾æ¥ï¼šhttps://github.com/rabbitmq/rabbitmq-server/tree/master/docs
[root@node3 ~]# netstat -tunlp | egrep '5672|4369'
tcp        0      0 0.0.0.0:25672           0.0.0.0:*               LISTEN      51619/beam.smp      
tcp        0      0 0.0.0.0:4369            0.0.0.0:*               LISTEN      30064/epmd               
tcp6       0      0 :::5672                 :::*                    LISTEN      51619/beam.smp      
tcp6       0      0 :::4369                 :::*                    LISTEN      30064/epmd          
æ³¨ï¼šç«¯å£è§£é‡Šï¼š
4369ï¼šRabbitMQèŠ‚ç‚¹å’ŒCLIå·¥å…·ä½¿ç”¨çš„å¯¹ç­‰å‘ç°æœåŠ¡ç«¯å£
5672ï¼šAMQPç«¯å£ï¼Œç”¨äºAPIç¼–ç¨‹
25672ï¼šé›†ç¾¤ç«¯å£
# æ·»åŠ ç”¨æˆ·ï¼š
[root@node3 download]# rabbitmqctl add_user admin password
Adding user "admin" ...
# è®¾ç½®ç”¨æˆ·è§’è‰²ï¼š
#tagï¼ˆadministratorï¼Œmonitoringï¼Œpolicymakerï¼Œmanagementï¼‰
[root@node3 download]# rabbitmqctl set_user_tags admin administrator
Setting tags for user "admin" to [administrator] ...
#è®¾ç½®ç”¨æˆ·æƒé™ï¼š
#è®¾ç½®ç”¨æˆ·æƒé™(æ¥å—æ¥è‡ªæ‰€æœ‰Hostçš„æ‰€æœ‰æ“ä½œ)
[root@node3 download]# rabbitmqctl set_permissions -p '/' admin '.*' '.*' '.*'
Setting permissions for user "admin" in vhost "/" ...
#åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·åŠæ‰€å±è§’è‰²
[root@node3 download]# rabbitmqctl list_users
Listing users ...
user	tags
admin	[administrator]
guest	[administrator]
#åˆ—å‡ºæŒ‡å®šç”¨æˆ·æƒé™
[root@node3 download]# rabbitmqctl list_user_permissions admin
Listing permissions for user "admin" ...
vhost	configure	write	read
/	.*	.*	.*
[root@node3 rabbit@node3]# rabbitmq-plugins enable rabbitmq_management #å¼€å¯æ’ä»¶ï¼Œæ­¤æ—¶ä¼šæ‰“å¼€15652ç«¯å£ï¼Œå¯ä»¥é€šè¿‡webç®¡ç†rabbitmq-server
Enabling plugins on node rabbit@node3:
rabbitmq_management
The following plugins have been configured:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch
Applying plugin configuration to rabbit@node3...
The following plugins have been enabled:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch
started 3 plugins.
æ³¨ï¼šæ­¤æ—¶ä¼šæ‰“å¼€15672ç«¯å£ï¼Œè¿™ä¸ªç«¯å£ç”¨äºweb-manager 

# æ·»åŠ ç”¨æˆ·
sudo rabbitmqctl add_user <username> <password>  
# åˆ é™¤ç”¨æˆ·
sudo rabbitmqctl delete_user <username>  
# ä¿®æ”¹ç”¨æˆ·å¯†ç 
sudo rabbitmqctl change_password <username> <newpassword>  
# æ¸…é™¤ç”¨æˆ·å¯†ç ï¼ˆè¯¥ç”¨æˆ·å°†ä¸èƒ½ä½¿ç”¨å¯†ç ç™»é™†ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡SASLç™»é™†å¦‚æœé…ç½®äº†SASLè®¤è¯ï¼‰
sudo rabbitmqctl clear_password <username> 
# è®¾ç½®ç”¨æˆ·tagsï¼ˆç›¸å½“äºè§’è‰²ï¼ŒåŒ…å«administratorï¼Œmonitoringï¼Œpolicymakerï¼Œmanagementï¼‰
sudo rabbitmqctl set_user_tags <username> <tag>
# åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
sudo rabbitmqctl list_users  
# åˆ›å»ºä¸€ä¸ªvhosts
sudo rabbitmqctl add_vhost <vhostpath>  
# åˆ é™¤ä¸€ä¸ªvhosts
sudo rabbitmqctl delete_vhost <vhostpath>  
# åˆ—å‡ºvhosts
sudo rabbitmqctl list_vhosts [<vhostinfoitem> ...]  
# é’ˆå¯¹ä¸€ä¸ªvhostsç»™ç”¨æˆ·èµ‹äºˆç›¸å…³æƒé™ï¼›
sudo rabbitmqctl set_permissions [-p <vhostpath>] <user> <conf> <write> <read>  
# æ¸…é™¤ä¸€ä¸ªç”¨æˆ·å¯¹vhostsçš„æƒé™ï¼›
sudo rabbitmqctl clear_permissions [-p <vhostpath>] <username>  
# åˆ—å‡ºå“ªäº›ç”¨æˆ·å¯ä»¥è®¿é—®è¯¥vhostsï¼›
sudo rabbitmqctl list_permissions [-p <vhostpath>]   
# åˆ—å‡ºç”¨æˆ·è®¿é—®æƒé™ï¼›
sudo rabbitmqctl list_user_permissions <username>



###ç”¨pythonæµ‹è¯•rabbitmqç”Ÿäº§å’Œæ¶ˆè´¹ï¼š
[root@node1 ~]# pip3 install pika
[root@node3 ~]# cat rabbitmq-sent.py 
#!/usr/bin/env python3
import pika  
import random  
#input loginname and password 
credentials = pika.PlainCredentials('admin', 'password')  
#ip,port,vhost
parameters = pika.ConnectionParameters('192.168.43.203',5672,'test',credentials)    
connection = pika.BlockingConnection(parameters)    
channel = connection.channel()    
#create or declare queue,set name and durable
channel.queue_declare(queue="homsom",durable=True)    
#create or declare exchange,set name and durable
channel.exchange_declare("homsom","direct",durable=True)    
#1.queue name 2.exchange name
channel.queue_bind("homsom","homsom",routing_key="hm")
#'hm' name is routing key ,it already biding homsom queue  
for i in range(0,1000):
  number = random.randint(0,1000)  
  body = 'hello world:%s' % number  
  channel.basic_publish(exchange='homsom',
                      routing_key='hm',    
                      body=body,properties=pika.spec.BasicProperties(delivery_mode=2)) #delivery_mode=2 is persistent,equle 1 is transient
  print(" [x] Sent %s" % body)
connection.close()
[root@node3 ~]# cat rabbitmq-receive.py 
#!/usr/bin/env python3
import pika  
import random  
        
credentials = pika.PlainCredentials('admin', 'password')  
parameters = pika.ConnectionParameters('192.168.43.203',5672,'test',credentials)    
connection = pika.BlockingConnection(parameters)    
channel = connection.channel()    
#down 'homsom' is queue name  
for method_frame, properties, body in channel.consume('homsom'):
    # Display the message parts and acknowledge the message
    print(method_frame, properties, body)
    channel.basic_ack(method_frame.delivery_tag)
    # Escape out of the loop after 10 messages
    if method_frame.delivery_tag == 1000:
        break
# Cancel the consumer and return any pending messages
requeued_messages = channel.cancel()
print('Requeued %i messages' % requeued_messages)
connection.close()

#è·å–ç¾¤é›†çŠ¶æ€
$ rabbitmqctl cluster_status
Cluster status of node rabbit@computingforgeeks-centos7 ...
[{nodes,[{disc,['rabbit@computingforgeeks-centos7']}]},
{running_nodes,['rabbit@computingforgeeks-centos7']},
{cluster_name,<<"rabbit@computingforgeeks-centos7">>},
{partitions,[]},
{alarms,[{'rabbit@computingforgeeks-centos7',[]}]}]
#å¤‡ä»½RabbitMQé…ç½®
è¯·æ³¨æ„ï¼Œæ­¤å¤‡ä»½ä¸åŒ…å«æ¶ˆæ¯ï¼Œå› ä¸ºå®ƒä»¬å­˜å‚¨åœ¨å•ç‹¬çš„æ¶ˆæ¯å­˜å‚¨åº“ä¸­ï¼Œå®ƒåªä¼šå¤‡ä»½RabbitMQç”¨æˆ·ã€vhostã€é˜Ÿåˆ—ã€äº¤æ¢å’Œç»‘å®šï¼Œå¤‡ä»½æ–‡ä»¶æ˜¯RabbitMQå…ƒæ•°æ®çš„JSONè¡¨ç¤ºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨rabbitmqadminå‘½ä»¤è¡Œå·¥å…·è¿›è¡Œå¤‡ä»½ã€‚
ç®¡ç†æ’ä»¶é™„å¸¦å‘½ä»¤è¡Œå·¥å…·rabbitmqadminï¼Œä½ éœ€è¦å¯ç”¨ç®¡ç†æ’ä»¶ï¼š
rabbitmq-plugins enable rabbitmq_management
æ­¤æ’ä»¶ç”¨äºæ‰§è¡Œä¸åŸºäºWebçš„UIç›¸åŒçš„ä¸€äº›æ“ä½œï¼Œè¿™å¯¹äºè‡ªåŠ¨åŒ–ä»»åŠ¡å¯èƒ½æ›´æ–¹ä¾¿ã€‚
#ä¸‹è½½rabbitmqadmin
å¯ç”¨ç®¡ç†æ’ä»¶åï¼Œä¸‹è½½ä¸HTTP APIäº¤äº’çš„rabbitmqadmin Pythonå‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒå¯ä»¥ä»ä»»ä½•å¯ç”¨äº†ç®¡ç†æ’ä»¶çš„RabbitMQèŠ‚ç‚¹ä¸‹è½½ï¼š
http://{node-hostname}:15672/cli/
ä¸‹è½½åï¼Œä½¿æ–‡ä»¶å¯æ‰§è¡Œå¹¶å°†å…¶ç§»åŠ¨åˆ°/usr/local/binç›®å½•ï¼š
chmod +x rabbitmqadmin
sudo mv rabbitmqadmin /usr/local/bin
è¦å¤‡ä»½RabbitMQé…ç½®ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
rabbitmqadmin export <backup-file-name>
æ¯”å¦‚ï¼š
$ rabbitmqadmin export rabbitmq-backup-config.json
Exported definitions for localhost to "rabbitmq-backup-config.json"
å¯¼å‡ºå†™å…¥æ–‡ä»¶filerabbitmq-backup-config.jsonã€‚
#æ¢å¤RabbitMQé…ç½®å¤‡ä»½
å¦‚æœä½ æƒ³ä»å¤‡ä»½ä¸­æ¢å¤RabbitMQé…ç½®ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
rabbitmqadmin import <JSON backup file >
æ¯”å¦‚ï¼š
$ rabbitmqadmin import rabbitmq-backup.json 
Imported definitions for localhost from "rabbitmq-backup.json"
#å¤‡ä»½RabbitMQæ•°æ®
RabbitMQå®šä¹‰å’Œæ¶ˆæ¯å­˜å‚¨åœ¨ä½äºèŠ‚ç‚¹æ•°æ®ç›®å½•ä¸­çš„å†…éƒ¨æ•°æ®åº“ä¸­ï¼Œè¦è·å–ç›®å½•è·¯å¾„ï¼Œè¯·é’ˆå¯¹æ­£åœ¨è¿è¡Œçš„RabbitMQèŠ‚ç‚¹è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
rabbitmqctl eval 'rabbit_mnesia:dir().'
è¾“å‡ºç¤ºä¾‹ï¼š
"/var/lib/rabbitmq/mnesia/rabbit@computingforgeeks-server1"
è¯¥ç›®å½•åŒ…å«è®¸å¤šæ–‡ä»¶ï¼š
# ls /var/lib/rabbitmq/mnesia/rabbit@computingforgeeks-centos7
åœ¨ä»3.7.0å¼€å§‹çš„RabbitMQç‰ˆæœ¬ä¸­ï¼Œæ‰€æœ‰æ¶ˆæ¯æ•°æ®éƒ½ç»„åˆåœ¨msg_stores/vhostsç›®å½•ä¸­ï¼Œå¹¶å­˜å‚¨åœ¨æ¯ä¸ªvhostçš„å­ç›®å½•ä¸­ï¼Œæ¯ä¸ªvhostç›®å½•éƒ½ä½¿ç”¨æ•£åˆ—å‘½åï¼Œå¹¶åŒ…å«å¸¦æœ‰vhoståç§°çš„.vhostæ–‡ä»¶ï¼Œå› æ­¤å¯ä»¥å•ç‹¬å¤‡ä»½ç‰¹å®šçš„vhostæ¶ˆæ¯é›†ã€‚
è¦åšRabbitMQå®šä¹‰å’Œæ¶ˆæ¯æ•°æ®å¤‡ä»½ï¼Œå¤åˆ¶æˆ–å½’æ¡£æ­¤ç›®å½•åŠå…¶å†…å®¹ï¼Œä½†å…ˆéœ€è¦åœæ­¢RabbitMQæœåŠ¡ï¼š
sudo systemctl stop rabbitmq-server.service
ä»¥ä¸‹ç¤ºä¾‹å°†åˆ›å»ºä¸€ä¸ªå­˜æ¡£ï¼š
tar cvf rabbitmq-backup.tgz /var/lib/rabbitmq/mnesia/rabbit@computingforgeeks-centos7
#æ¢å¤RabbitMQæ•°æ®
è¦ä»å¤‡ä»½ä¸­è¿˜åŸï¼Œè¯·å°†æ–‡ä»¶ä»å¤‡ä»½æå–åˆ°æ•°æ®ç›®å½•ã€‚
å†…éƒ¨èŠ‚ç‚¹æ•°æ®åº“åœ¨æŸäº›è®°å½•ä¸­å­˜å‚¨èŠ‚ç‚¹çš„åç§°ï¼Œå¦‚æœèŠ‚ç‚¹åç§°å‘ç”Ÿæ›´æ”¹ï¼Œåˆ™å¿…é¡»é¦–å…ˆä½¿ç”¨ä»¥ä¸‹rabbitmqctlå‘½ä»¤æ›´æ–°æ•°æ®åº“ä»¥ä¾¿æ›´æ”¹ï¼š
rabbitmqctl rename_cluster_node <oldnode> <newnode>
å½“æ–°èŠ‚ç‚¹ä»¥å¤‡ä»½ç›®å½•å’ŒåŒ¹é…çš„èŠ‚ç‚¹åç§°å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæ ¹æ®éœ€è¦æ‰§è¡Œå‡çº§æ­¥éª¤å¹¶ç»§ç»­å¼•å¯¼ã€‚

##å•ä¸€èŠ‚ç‚¹å¤‡ä»½æ¢å¤å®ä¾‹ï¼š
å¤‡ä»½RabbitMQé…ç½®:
[root@node2 ~]# rabbitmqadmin --host=192.168.43.203 --port=15672 --username=admin --password=password export backup.file
æ³¨ï¼šæˆ‘è¿™ä¸æ˜¯åœ¨æœ¬æœºä¸Šå¤‡ä»½é…ç½®ï¼Œå¦‚æœåœ¨æœ¬æœºä¸Šå¤‡ä»½æ— éœ€è¾“å…¥host,port,username,password
æ¢å¤RabbitMQé…ç½®ï¼š
[root@node2 ~]# rabbitmqadmin --host=192.168.43.203 --port=15672 --username=admin --password=password import backup.file
Uploaded definitions from "192.168.43.203" to backup.file. The import process may take some time. Consult server logs to track progress.
æ³¨ï¼šæˆ‘åœ¨æ¢å¤é…ç½®å‰åˆ é™¤äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå½“æ¢å¤é…ç½®åä¹Ÿå·²ç»æ¢å¤äº†ã€‚
å¤‡ä»½RabbitMQæ•°æ®ï¼š
[root@node3 rabbitmq]# rabbitmqctl eval 'rabbit_mnesia:dir().'
"/var/lib/rabbitmq/mnesia/rabbit@node3"
[root@node3 rabbitmq]# systemctl stop rabbitmq-server.service
[root@node3 rabbitmq]# tar cvf rabbitmq-backup.tgz /var/lib/rabbitmq/mnesia/rabbit@node3
æ¢å¤RabbitMQæ•°æ®ï¼š
æ¨¡æ‹Ÿnode3ä¸Šçš„rabbitMQå·²ç»æ•…éšœï¼Œåœ¨node2ä¸Šè¿›è¡Œè¿˜åŸå¤‡ä»½:
1.yumå®‰è£…erlangå’Œrabbitmq,æ›´æ”¹node2ä¸»æœºåä¸ºnode3ï¼ˆå¹¶ä¸”åœ¨å•èŠ‚ç‚¹ä¸­ï¼Œä¸»æœºåç§°è¦ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯è¯´node3å¤åˆ¶çš„æ•°æ®åˆ°node2ä¸­æ—¶ï¼Œnode2èŠ‚ç‚¹è¦æŠŠä¸»æœºåæ”¹æˆnode3ï¼Œå¦åˆ™æ¢å¤ä¸æˆåŠŸï¼‰ï¼ˆå½“æ¢å¤çš„æ˜¯é›†ç¾¤èŠ‚ç‚¹æ—¶éœ€è¦é‡å‘½åä¸‹æ–°çš„èŠ‚ç‚¹åç§°ã€‚æ€»ä½“æ­¥éª¤å’Œå•ä¸€èŠ‚ç‚¹å¤‡ä»½æ¢å¤æ­¥éª¤ä¸€æ ·ï¼‰
2.[root@node2 rabbitmq]# cp enabled_plugins rabbitmq.conf /etc/rabbitmq/  #å¤åˆ¶é…ç½®æ–‡ä»¶
[root@node2 rabbitmq]# cat enabled_plugins  #è¿™ä¸ªé…ç½®å¯ç”¨rabbitmq-plugins enable rabbitmq_managementå‘½ä»¤ä»£æ›¿
[rabbitmq_management].
[root@node2 rabbitmq]# egrep -v '#|^$' rabbitmq.conf 
listeners.tcp.default = 5672
3.[root@node2 rabbitmq]# mv var/lib/rabbitmq/mnesia/rabbit@node3 /var/lib/rabbitmq/mnesia/
4.[root@node2 rabbitmq]# systemctl start rabbitmq-server.service
5.[root@node2 rabbitmq]# netstat -tunlp | egrep '5672|4369'
tcp        0      0 0.0.0.0:25672           0.0.0.0:*               LISTEN      11141/beam.smp      
tcp        0      0 0.0.0.0:4369            0.0.0.0:*               LISTEN      11067/epmd          
tcp        0      0 0.0.0.0:15672           0.0.0.0:*               LISTEN      11141/beam.smp      
tcp6       0      0 :::5672                 :::*                    LISTEN      11141/beam.smp      
tcp6       0      0 :::4369                 :::*                    LISTEN      11067/epmd  
[root@node2 ~]# rabbitmqadmin import backup.file  #å‰ææ˜¯guestç”¨æˆ·å’Œguestå¯†ç ç”Ÿæ•ˆæ‰èƒ½æˆåŠŸå¯¼å…¥ï¼Œrabbitmqé»˜è®¤å°±æ˜¯è¿™ä¸ª
Uploaded definitions from "localhost" to backup.file. The import process may take some time. Consult server logs to track progress.
æ³¨ï¼šæ­¤æ—¶æ•°æ®å’Œå…ƒæ•°æ®éƒ½æˆåŠŸæ¢å¤
```



### 3.2 é›†ç¾¤éƒ¨ç½²

> å‰æï¼šnode2å’Œnode3ä¸¤ä¸ªrabbitmqèŠ‚ç‚¹éƒ½å·²ç»å®‰è£…å¥½ï¼Œä¸Šé¢æœ‰æ–¹æ³•å®‰è£…

```bash
[root@node3 ~]# cd /etc/rabbitmq/
[root@node3 rabbitmq]# cat rabbitmq-env.conf #ä¸è®¾ç½®å˜é‡ä¹Ÿå¯ï¼Œrabbité»˜è®¤æ˜¯è¿™ä¸ª
NODE_PORT=5672
NODENAME=rabbit
[root@node3 rabbitmq]# systemctl restart rabbitmq-server.service
[root@node2 mnesia]# cd /etc/rabbitmq/
[root@node2 rabbitmq]# cat rabbitmq-env.conf 
NODE_PORT=5672
NODENAME=rabbit
[root@node3 rabbitmq]# cat .erlang.cookie 
CWQUYERKZHUAGOEQMZZU
[root@node2 rabbitmq]# cat .erlang.cookie 
CWQUYERKZHUAGOEQMZZU
æ³¨ï¼šnode2å’Œnode3çš„cookieè¦ä¿æŒä¸€è‡´ï¼Œä¸ä¸€è‡´ä¿®æ”¹å³å¯ï¼Œæƒé™æ˜¯600ï¼Œç„¶åé‡å¯æœåŠ¡
[root@node2 rabbitmq]# ll -a
total 8
drwxr-xr-x   5 rabbitmq rabbitmq   70 Apr 22 17:15 .
drwxr-xr-x. 37 root     root     4096 Apr 22 15:39 ..
drwxr-x---   3 rabbitmq rabbitmq   23 Apr 22 17:27 config
-r--------   1 rabbitmq rabbitmq   21 Apr 22 17:15 .erlang.cookie
drwxr-x---   4 rabbitmq rabbitmq  119 Apr 22 17:27 mnesia
drwxr-x---   2 rabbitmq rabbitmq  101 Apr 22 15:47 schema
[root@node2 rabbitmq]# systemctl restart rabbitmq-server.service
[root@node2 rabbitmq]# rabbitmqctl stop_app 
Stopping rabbit application on node rabbit1@node2 ...
[root@node2 rabbitmq]# rabbitmqctl join_cluster rabbit@node3
Clustering node rabbit@node2 with rabbit@node3
[root@node2 rabbitmq]# rabbitmqctl start_app
Starting node rabbit@node2 ...
 completed with 3 plugins.
```

> æ­¤æ—¶å¯ä»¥åœ¨web-managermentå½“ä¸­çœ‹åˆ°ä¸¤ä¸ªèŠ‚ç‚¹ç»„æˆé›†ç¾¤äº†
> é›†ç¾¤æ¨¡å¼ä»…ä»…æ˜¯2ä¸ªå®ä¾‹å…±äº«äº†ä¿¡æ¯ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å®ç°queueé˜Ÿåˆ—å­˜å‚¨çš„é«˜å¯ç”¨ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰äº§ç”Ÿå‰¯æœ¬ã€‚éœ€è¦è®¾å®šç­–ç•¥è®©äº¤æ¢æœºå’Œé˜Ÿåˆ—éƒ½é•œåƒï¼Œæ¥ä¿è¯æ•°æ®çš„é«˜å¯ç”¨





## å››ã€RabbitMQæ¨¡å¼

``` bash
# RabbitMQä¸­é˜Ÿåˆ—æœ‰ä¸¤ç§æ¨¡å¼
1. é»˜è®¤ã€€ã€€Defaultã€€# é»˜è®¤æ¨¡å¼æ—¶ï¼Œå½“ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œä»èŠ‚ç‚¹ä¹Ÿéƒ½ä¼šè·Ÿç€æŒ‚æ‰ã€‚å…¶å®ƒé˜Ÿåˆ—å°†ä¸å¯ç”¨ï¼Œç‰¹ç‚¹ï¼šé«˜ååé‡ï¼Œéé«˜å¯ç”¨ 
2. é•œåƒã€€ã€€Mirrorã€€ # ç±»ä¼¼äºmongoDBï¼Œä»ä¸€ç›´åœ¨é€šè¿‡ä¸»çš„æ“ä½œæ—¥å¿—æ¥è¿›è¡ŒåŒæ­¥ï¼Œä¸»èŠ‚ç‚¹æŒ‚æ‰æ—¶ï¼Œæœ‰ä»èŠ‚ç‚¹é¡¶ç€ï¼Œæ­¤æ—¶ä»ç„¶å¯ä»¥è°ƒç”¨é˜Ÿåˆ—ã€‚ç‰¹ç‚¹ï¼šè¾ƒä½ååé‡ï¼Œé«˜å¯ç”¨ 

å¦‚æœå°†é˜Ÿåˆ—å®šä¹‰ä¸ºé•œåƒæ¨¡å¼ï¼Œé‚£ä¹ˆè¿™ä¸ªé˜Ÿåˆ—ä¹Ÿå°†åŒºåˆ†ä¸»ä»ï¼Œä»è€Œåšåˆ°äº†é˜Ÿåˆ—é«˜å¯ç”¨ã€‚é€šè¿‡ä¸€ä¸ªmasterï¼ˆä¸»ï¼‰å’Œå¤šä¸ªslaveï¼ˆä»ï¼‰ç»„æˆï¼Œæ¶ˆæ¯å‘å¸ƒåˆ°é˜Ÿåˆ—ä¸­å°†è¢«å¤åˆ¶åˆ°æ‰€æœ‰ä»èŠ‚ç‚¹ä¸Šã€‚æ¶ˆè´¹è€…è¿æ¥åˆ°ä¸»èŠ‚ç‚¹ä¸Šã€‚é…ç½®é•œåƒé˜Ÿåˆ—åªèƒ½é€šè¿‡policyè¿›è¡Œé…ç½®ï¼Œå¯ä»¥ä»å‘½ä»¤è¡Œä¹Ÿå¯ä»¥é€šè¿‡web UIå®ç°ã€‚

#è¿™ä¸ªç­–ç•¥å½“ä¸»èŠ‚ç‚¹æŒ‚æ‰åï¼Œä»èŠ‚ç‚¹æ¥ç®¡ä¸»èŠ‚ç‚¹ï¼Œæœ€åè€çš„ä¸»èŠ‚ç‚¹åœ¨çº¿äº†ï¼Œè€çš„ä¸»èŠ‚ç‚¹ä¸ä¼šè‡ªåŠ¨åŒæ­¥ï¼Œåªèƒ½æ‰‹åŠ¨åŒæ­¥ã€‚è¦æƒ³è‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦åŠ å‚æ•°"ha-sync-mode":"automatic"
[root@node2 rabbitmq]# rabbitmqctl set_policy --vhost / --priority 0 --apply-to queues ha-all "^test" '{"ha-mode":"all"}' 
Setting policy "ha-all" for pattern "^test" to "{"ha-mode":"all"}" with priority "0" for vhost "/" ...
#æ‰‹åŠ¨åŒæ­¥æ–°ä¸»èŠ‚ç‚¹çš„æ•°æ®åˆ°è€çš„ä¸»èŠ‚ç‚¹ï¼ˆæœ¬èŠ‚ç‚¹ï¼‰
[root@node3 rabbitmq]# rabbitmqctl sync_queue test   
Synchronising queue 'test' in vhost '/' ...
#åˆ—å‡ºç­–ç•¥
[root@node3 rabbitmq]# rabbitmqctl list_policies 
Listing policies for vhost "/" ...
vhost	name	pattern	apply-to	definition	priority
/	ha-all	^test	queues	{"ha-mode":"all"}	0
#åˆ é™¤ç­–ç•¥
[root@node3 rabbitmq]# rabbitmqctl clear_policy ha-all 
Clearing policy "ha-all" on vhost "/" ...
[root@node3 rabbitmq]# rabbitmqctl set_policy --vhost / --priority 0 --apply-to queues ha-all "^test" '{"ha-mode":"all","ha-sync-mode":"automatic"}'
Setting policy "ha-all" for pattern "^test" to "{"ha-mode":"all","ha-sync-mode":"automatic"}" with priority "0" for vhost "/" ...
#æ–°å»ºäº†ä¸€ä¸ªé’ˆå¯¹ä»»æ„äº¤æ¢æœºå’Œé˜Ÿåˆ—çš„ç­–ç•¥ï¼Œä»–ä»¬éƒ½å¯ä»¥å¾—åˆ°mirrorsæ¨¡å¼ï¼Œæ˜¯é’ˆå¯¹vhost:/çš„ï¼Œä¼˜å…ˆçº§æ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆåº”ç”¨ã€‚
[root@node3 rabbitmq]# rabbitmqctl set_policy --vhost / --priority 10 --apply-to 'all' all ".*" '{"ha-mode":"all","ha-sync-mode":"automatic"}' 
Setting policy "all" for pattern ".*" to "{"ha-mode":"all","ha-sync-mode":"automatic"}" with priority "10" for vhost "/" ...
#ä¸»èŠ‚ç‚¹ä¸‹çº¿åå†ä¸Šçº¿å°†ä¼šè‡ªåŠ¨åŒæ­¥æ•°æ®
[root@node3 rabbitmq]# rabbitmqctl list_policies 
Listing policies for vhost "/" ...
vhost	name	pattern	apply-to	definition	priority
/	ha-all	^test	queues	{"ha-mode":"all","ha-sync-mode":"automatic"}	0
/	all	.*	all	{"ha-mode":"all","ha-sync-mode":"automatic"}	10
###åœ¨RabbitMQé›†ç¾¤ä¸­çš„èŠ‚ç‚¹åªæœ‰ä¸¤ç§ç±»å‹ï¼šå†…å­˜èŠ‚ç‚¹/ç£ç›˜èŠ‚ç‚¹ï¼Œå•èŠ‚ç‚¹ç³»ç»Ÿåªè¿è¡Œç£ç›˜ç±»å‹çš„èŠ‚ç‚¹ã€‚è€Œåœ¨é›†ç¾¤ä¸­ï¼Œå¯ä»¥é€‰æ‹©é…ç½®éƒ¨åˆ†èŠ‚ç‚¹ä¸ºå†…å­˜èŠ‚ç‚¹ã€‚å†…å­˜èŠ‚ç‚¹å°†æ‰€æœ‰çš„é˜Ÿåˆ—ï¼Œäº¤æ¢å™¨ï¼Œç»‘å®šå…³ç³»ï¼Œç”¨æˆ·ï¼Œæƒé™ï¼Œå’Œvhostçš„å…ƒæ•°æ®ä¿¡æ¯ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚ç£ç›˜èŠ‚ç‚¹å°†è¿™äº›ä¿¡æ¯ä¿å­˜åœ¨ç£ç›˜ä¸­ï¼Œä½†æ˜¯å†…å­˜èŠ‚ç‚¹çš„æ€§èƒ½æ›´é«˜ï¼Œä¸ºäº†ä¿è¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§ï¼Œå¿…é¡»ä¿è¯é›†ç¾¤ä¸­æœ‰ä¸¤ä¸ªä»¥ä¸Šçš„ç£ç›˜èŠ‚ç‚¹ï¼Œæ¥ä¿è¯å½“æœ‰ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹å´©æºƒäº†ï¼Œé›†ç¾¤è¿˜èƒ½å¯¹å¤–æä¾›è®¿é—®æœåŠ¡ã€‚
#æ›´æ”¹ä¸€ä¸ªèŠ‚ç‚¹ä»discï¼ˆç£ç›˜èŠ‚ç‚¹ï¼‰åˆ°ramï¼ˆå†…å­˜èŠ‚ç‚¹ï¼‰ï¼Œè¿™é‡Œåªæ˜¯æµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒåªæœ€å°‘ä¸‰ä¸ªèŠ‚ç‚¹æ‰èƒ½æœ‰ä¸€ä¸ªå†…å­˜èŠ‚ç‚¹
[root@node2 rabbitmq]# rabbitmqctl stop_app
Stopping rabbit application on node rabbit@node2 ...
[root@node2 rabbitmq]# rabbitmqctl change_cluster_node_type ram
Turning rabbit@node2 into a ram node
[root@node2 rabbitmq]# rabbitmqctl start_app
Starting node rabbit@node2 ...
 completed with 3 plugins.
```

> #### **`ha-sync-mode: automatic` çš„å½±å“**
>
> - `automatic`ï¼šæ–°åŠ å…¥çš„é•œåƒèŠ‚ç‚¹ä¼š**è‡ªåŠ¨åŒæ­¥ä¸»å‰¯æœ¬ä¸Šçš„æ‰€æœ‰æ¶ˆæ¯**ï¼ˆåŒ…æ‹¬å†å²æ¶ˆæ¯ï¼‰ã€‚
> - ç¼ºç‚¹ï¼šå¦‚æœé˜Ÿåˆ—å¾ˆå¤§ï¼ŒåŒæ­¥è¿‡ç¨‹ä¼šæ¶ˆè€—å¤§é‡å†…å­˜å’Œç½‘ç»œå¸¦å®½ï¼Œå¯èƒ½å¯¼è‡´èŠ‚ç‚¹ OOM æˆ–é˜»å¡ã€‚
> - æ›¿ä»£æ–¹æ¡ˆï¼š`manual`ï¼ˆé»˜è®¤ï¼‰ï¼Œéœ€æ‰‹åŠ¨æ‰§è¡Œ `rabbitmqctl sync_queue` è§¦å‘åŒæ­¥ã€‚
>
> > ğŸ“Œ ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š
> >
> > - å°é˜Ÿåˆ—å¯ç”¨ `automatic`
> > - å¤§é˜Ÿåˆ—å»ºè®®ç”¨ `manual` + ç›‘æ§åŒæ­¥çŠ¶æ€
>
> #### **Mirrored Queues å·²è¢«å¼ƒç”¨ï¼ˆé‡è¦ï¼ï¼‰**
>
> - RabbitMQ è‡ª **3.8.0 èµ·æ¨èä½¿ç”¨ Quorum Queues** æ›¿ä»£ Mirrored Queuesã€‚
> - Mirrored Queues åœ¨æœªæ¥ç‰ˆæœ¬ä¸­å¯èƒ½è¢«ç§»é™¤ã€‚
> - Quorum Queues æä¾›æ›´å¼ºä¸€è‡´æ€§ã€æ›´å¯é æ•…éšœæ¢å¤ã€‚
>
> âœ… å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ RabbitMQ â‰¥ 3.8ï¼Œ**å»ºè®®æ”¹ç”¨ Quorum Queue**ï¼š
>
> ```bash
> # å£°æ˜ quorum queueï¼ˆé€šè¿‡å®¢æˆ·ç«¯æˆ– rabbitmqadminï¼‰
> # æˆ–è®¾ç½®ç­–ç•¥ï¼ˆä»…é€‚ç”¨äºæ–°å£°æ˜çš„é˜Ÿåˆ—ï¼‰ï¼š
> rabbitmqctl set_policy -p my_vhost quorum-policy ".*" '{"queue-type":"quorum"}' --apply-to queues
> 
> 
> # æœ€ç»ˆæ¨èå‘½ä»¤ï¼ˆClassic Mirrored Queue åœºæ™¯ï¼‰
> rabbitmqctl set_policy -p my_vhost ha-all ".*" '{"ha-mode":"all","ha-sync-mode":"manual"}' --priority 10 --apply-to queues
> # å¯¹å…³é”®é˜Ÿåˆ—æ‰‹åŠ¨åŒæ­¥
> rabbitmqctl sync_queue -p my_vhost your_queue_name
> # éªŒè¯ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆ
> rabbitmqctl list_policies -p my_vhost
> # æŸ¥çœ‹é˜Ÿåˆ—å‰¯æœ¬
> rabbitmqctl list_queues -p my_vhost name slave_pids synchronised_slave_pids
> ```









## äº”ã€dockeréƒ¨ç½²RabbitMQ

rabbitmqé›†ç¾¤æ˜¯æ— ä¸»é›†ç¾¤ï¼Œä»»æ„èŠ‚ç‚¹å¯å†™å…¥ï¼Œä¸€èˆ¬é›†ç¾¤éƒ½æ˜¯æ— ä¸»é›†ç¾¤,ä½†æ˜¯ä¼šå­˜åœ¨é€‰ä¸¾æœºåˆ¶ã€‚é™¤ä¸»ä»é›†ç¾¤å¤–ã€‚

```bash
#èŠ‚ç‚¹1
----è¿è¡Œrabbitmq1:
docker run -d --restart=always \
--hostname rabbit1 \
--name myrabbit1 \
-v /home/dockerdata/rabbitmq:/var/lib/rabbitmq  \
-p 25672:25672 \
-p 15672:15672 \
-p 5672:5672 \
-p 4369:4369 \
-e RABBITMQ_ERLANG_COOKIE='rabbitcookie' \
-e RABBITMQ_DEFAULT_USER=admin \
-e RABBITMQ_DEFAULT_PASS=p@ss123.com \
--add-host rabbit2:192.168.15.202 \
--add-host rabbit3:192.168.15.203 \
rabbitmq:3.8.9-management

æ³¨ï¼šç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥ä¸ç”¨å†™å…¥å…¶å®ƒä¸»æœºä¸»æœºåï¼Œå› ä¸ºå…¶å®ƒèŠ‚ç‚¹æ˜¯åŠ å…¥æ­¤èŠ‚ç‚¹ä¸ºé›†ç¾¤çš„ã€‚ä¹Ÿå¯å†™å…¥ï¼Œä¾‹å¦‚ï¼š--add-host rabbit2:192.168.15.202 --add-host rabbit3:192.168.15.203
----è®¾ç½®é›†ç¾¤é…ç½®ï¼š
docker exec -it myrabbit1 bash
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl start_app
exit


#èŠ‚ç‚¹2
----è¿è¡Œrabbitmq2:
docker run -d --restart=always \
--hostname rabbit2 \
--name myrabbit2 \
-v /home/dockerdata/rabbitmq:/var/lib/rabbitmq  \
-p 25672:25672 \
-p 15672:15672 \
-p 5672:5672 \
-p 4369:4369 \
-e RABBITMQ_ERLANG_COOKIE='rabbitcookie' \
-e RABBITMQ_DEFAULT_USER=admin \
-e RABBITMQ_DEFAULT_PASS=p@ss123.com \
--add-host rabbit1:192.168.15.201 \
--add-host rabbit3:192.168.15.203 \
rabbitmq:3.8.9-management
----è®¾ç½®é›†ç¾¤é…ç½®ï¼š
docker exec -it myrabbit2 bash
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster --ram rabbit@rabbit1
rabbitmqctl start_app
exit


#èŠ‚ç‚¹3
----è¿è¡Œrabbitmq3:
docker run -d --restart=always \
--hostname rabbit3 \
--name myrabbit3 \
-v /home/dockerdata/rabbitmq:/var/lib/rabbitmq  \
-p 25672:25672 \
-p 15672:15672 \
-p 5672:5672 \
-p 4369:4369 \
-e RABBITMQ_ERLANG_COOKIE='rabbitcookie' \
-e RABBITMQ_DEFAULT_USER=admin \
-e RABBITMQ_DEFAULT_PASS=p@ss123.com \
--add-host rabbit1:192.168.15.201 \
--add-host rabbit2:192.168.15.202 \
rabbitmq:3.8.9-management
docker run -d --restart=always --add-host rabbit1:192.168.15.201 --add-host rabbit2:192.168.15.203 --hostname rabbit3 --name myrabbit3 -p 25672:25672 -p 15672:15672 -p 5672:5672 -p 4369:4369 -e RABBITMQ_ERLANG_COOKIE='rabbitcookie' rabbitmq:3.8.9-management  
----è®¾ç½®é›†ç¾¤é…ç½®ï¼š
docker exec -it myrabbit3 bash
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster rabbit@rabbit1
rabbitmqctl start_app
exit

#ä»»æ„èŠ‚ç‚¹è®¾ç½®é›†ç¾¤ä¸ºHAé•œåƒæ¨¡å¼ï¼š
rabbitmqctl set_policy --vhost / --priority 10 --apply-to 'all' all ".*" '{"ha-mode":"all","ha-sync-mode":"automatic"}' 
æ³¨ï¼šè¿™æ¡ç­–ç•¥æ˜¯é’ˆå¯¹vhostä¸º'/'çš„ã€‚å¦‚æœå¢åŠ äº†ä¸€ä¸ªvhostä¸º'/test'ï¼Œåˆ™éœ€è¦å†å¢åŠ ä¸€æ¡é’ˆå¯¹'/test'çš„ç­–ç•¥ï¼Œ'/'ä¸åŒ…å«'/test'

#ç”¨æˆ·é…ç½®
--æ·»åŠ ä¸€ä¸ªç®¡ç†å‘˜è®¾ç½®å¯†ç ã€è§’è‰²ã€æƒé™
rabbitmqctl add_user admin p@ss123.com
rabbitmqctl set_user_tags admin administrator
rabbitmqctl set_permissions -p '/' admin '.*' '.*' '.*'
--æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ã€æŒ‡å®šç”¨æˆ·æƒé™
rabbitmqctl list_users
rabbitmqctl list_user_permissions admin
--æ¸…é™¤ç”¨æˆ·å¯†ç å¹¶ç¦ç”¨æ­¤ç”¨æˆ·
rabbitmqctl clear_password guest
--è®¾ç½®ç”¨æˆ·å¯†ç å¹¶å¯ç”¨æ­¤ç”¨æˆ·
rabbitmqctl change_password guest 123


---
Description: one node for docker rabbitmqCluster.
docker run -d --restart=always \
--hostname rabbit_test1 \
--name rabbit_test1 \
-v /home/dockerdata/rabbitmq1:/var/lib/rabbitmq  \
-p 25672:25672 \
-p 15672:15672 \
-p 5672:5672 \
-p 4369:4369 \
-e RABBITMQ_ERLANG_COOKIE='rabbitcookie!@#' \
-e RABBITMQ_DEFAULT_USER=admin \
-e RABBITMQ_DEFAULT_PASS=p@ss123.com \
rabbitmq:3.8.9-management

docker exec -it rabbit_test1 bash
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl start_app
exit


docker run -d --restart=always \
--hostname rabbit_test2 \
--name rabbit_test2 \
-v /home/dockerdata/rabbitmq2:/var/lib/rabbitmq  \
-p 25673:25672 \
-p 15673:15672 \
-p 5673:5672 \
-p 4370:4369 \
-e RABBITMQ_ERLANG_COOKIE='rabbitcookie!@#' \
-e RABBITMQ_DEFAULT_USER=admin \
-e RABBITMQ_DEFAULT_PASS=p@ss123.com \
--link rabbit_test1:rabbit_test1 \
rabbitmq:3.8.9-management

docker exec -it rabbit_test2 bash
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster rabbit@rabbit_test1 
rabbitmqctl start_app
exit



docker run -d --restart=always \
--hostname rabbit_test3 \
--name rabbit_test3 \
-v /home/dockerdata/rabbitmq3:/var/lib/rabbitmq  \
-p 25674:25672 \
-p 15674:15672 \
-p 5674:5672 \
-p 4371:4369 \
-e RABBITMQ_ERLANG_COOKIE='rabbitcookie!@#' \
-e RABBITMQ_DEFAULT_USER=admin \
-e RABBITMQ_DEFAULT_PASS=p@ss123.com \
--link rabbit_test1:rabbit_test1 \
--link rabbit_test2:rabbit_test2 \
rabbitmq:3.8.9-management

docker exec -it rabbit_test3 bash
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster --ram rabbit@rabbit_test2 
rabbitmqctl start_app
exit


rabbitmqctl add_user rabbituser homsom
----è§’è‰²administratorã€monitoringã€policymakerã€managementã€å…¶å®ƒ
rabbitmqctl set_user_tags rabbituser users
rabbitmqctl set_permissions -p '/' rabbituser '.*' '.*' '.*'
rabbitmqctl clear_permissions -p / rabbituser
rabbitmqctl list_permissions -p '/'

192.168.13.50:5672ï¼Œ192.168.13.50:5673ï¼Œ192.168.13.50:5674



------
DATETIME: 20210302
ç”Ÿäº§ç¯å¢ƒRabbitMQ Dockeréƒ¨ç½²ï¼š
rabbitmq01: 192.168.13.235
rabbitmq02: 192.168.13.65
rabbitmq03: 192.168.13.160

#èŠ‚ç‚¹1
----è¿è¡Œrabbitmq01:
docker run -d --restart=always \
--hostname rabbitmq01 \
--name rabbitmq01 \
-v /home/dockerdata/rabbitmq:/var/lib/rabbitmq  \
-p 25672:25672 \
-p 15672:15672 \
-p 5672:5672 \
-p 4369:4369 \
-e RABBITMQ_ERLANG_COOKIE='rabbitcookie@homsom' \
-e RABBITMQ_DEFAULT_USER=admin \
-e RABBITMQ_DEFAULT_PASS=p@ss123.com \
--add-host rabbitmq02:192.168.13.65 \
--add-host rabbitmq03:192.168.13.160 \
rabbitmq:3.8.9-management
----è®¾ç½®é›†ç¾¤é…ç½®ï¼š
docker exec -it rabbitmq01 bash
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl start_app
exit


#èŠ‚ç‚¹2
----è¿è¡Œrabbitmq02:
docker run -d --restart=always \
--hostname rabbitmq02 \
--name rabbitmq02 \
-v /dockerdata/rabbitmq:/var/lib/rabbitmq  \
-p 25672:25672 \
-p 15672:15672 \
-p 5672:5672 \
-p 4369:4369 \
-e RABBITMQ_ERLANG_COOKIE='rabbitcookie@homsom' \
-e RABBITMQ_DEFAULT_USER=admin \
-e RABBITMQ_DEFAULT_PASS=p@ss123.com \
--add-host rabbitmq01:192.168.13.235 \
--add-host rabbitmq03:192.168.13.160 \
rabbitmq:3.8.9-management
----è®¾ç½®é›†ç¾¤é…ç½®ï¼š
docker exec -it rabbitmq02 bash
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster --ram rabbit@rabbitmq01
rabbitmqctl start_app
exit


#èŠ‚ç‚¹3
----è¿è¡Œrabbitmq03:
docker run -d --restart=always \
--hostname rabbitmq03 \
--name rabbitmq03 \
-v /home/dockerdata/rabbitmq:/var/lib/rabbitmq  \
-p 25672:25672 \
-p 15672:15672 \
-p 5672:5672 \
-p 4369:4369 \
-e RABBITMQ_ERLANG_COOKIE='rabbitcookie@homsom' \
-e RABBITMQ_DEFAULT_USER=admin \
-e RABBITMQ_DEFAULT_PASS=p@ss123.com \
--add-host rabbitmq01:192.168.13.235 \
--add-host rabbitmq02:192.168.13.65 \
rabbitmq:3.8.9-management
----è®¾ç½®é›†ç¾¤é…ç½®ï¼š
docker exec -it rabbitmq03 bash
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster rabbit@rabbitmq02
rabbitmqctl start_app
exit


#ä»»æ„èŠ‚ç‚¹è®¾ç½®é›†ç¾¤ä¸ºHAé•œåƒæ¨¡å¼ï¼š
rabbitmqctl set_policy --vhost / --priority 10 --apply-to 'all' all ".*" '{"ha-mode":"all","ha-sync-mode":"automatic"}' 
æ³¨ï¼šè¿™æ¡ç­–ç•¥æ˜¯é’ˆå¯¹vhostä¸º'/'çš„ã€‚å¦‚æœå¢åŠ äº†ä¸€ä¸ªvhostä¸º'/test'ï¼Œåˆ™éœ€è¦å†å¢åŠ ä¸€æ¡é’ˆå¯¹'/test'çš„ç­–ç•¥ï¼Œ'/'ä¸åŒ…å«'/test'

rabbitmqctl set_policy --vhost my_vhost --priority 10 --apply-to 'all' all ".*" '{"ha-mode":"all","ha-sync-mode":"automatic"}' 

#ç”¨æˆ·é…ç½®
--æ·»åŠ ä¸€ä¸ªç®¡ç†å‘˜è®¾ç½®å¯†ç ã€è§’è‰²ã€æƒé™
rabbitmqctl add_user admin p@ssword
rabbitmqctl set_user_tags admin administrator
rabbitmqctl set_permissions -p '/' admin '.*' '.*' '.*'
--æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ã€æŒ‡å®šç”¨æˆ·æƒé™
rabbitmqctl list_users
rabbitmqctl list_user_permissions admin
--æ¸…é™¤ç”¨æˆ·å¯†ç å¹¶ç¦ç”¨æ­¤ç”¨æˆ·
rabbitmqctl clear_password guest
--è®¾ç½®ç”¨æˆ·å¯†ç å¹¶å¯ç”¨æ­¤ç”¨æˆ·
rabbitmqctl change_password guest 123

å¢åŠ æ™®é€šç”¨æˆ·ï¼š
rabbitmqctl add_user rabbituser homsom123
rabbitmqctl set_user_tags rabbituser users
rabbitmqctl set_permissions -p '/' rabbituser '.*' '.*' '.*'
rabbitmqctl list_permissions -p '/'
rabbitmqctl list_users


rabbitmqctl add_user devadmin homsom
rabbitmqctl set_user_tags devadmin administrator
rabbitmqctl set_permissions -p '/' devadmin '.*' '.*' '.*'
rabbitmqctl list_permissions -p '/'
rabbitmqctl list_users

```







## å…­ã€å°è®°

>  202104282012å®æ“è¿ç§»ç”Ÿäº§rabbitmqèŠ‚ç‚¹



### 6.1 rabbitmq docker é›†ç¾¤èŠ‚ç‚¹ç§»é™¤

ç§»é™¤èŠ‚ç‚¹ï¼š192.168.13.65

```
# åœ¨ä¸»èŠ‚ç‚¹,ä¹Ÿå°±æ˜¯å‘èµ·é›†ç¾¤çš„ä¸»æœºä¸Šè¿›è¡ŒèŠ‚ç‚¹çš„ç§»é™¤
[root@harbor ~]# docker exec -it rabbitmq01 /bin/sh
# rabbitmqctl cluster_status
Cluster status of node rabbit@rabbitmq01 ...
Basics
Cluster name: rabbit@rabbitmq01
# rabbitmqctl forget_cluster_node rabbit@rabbitmq02
Removing node rabbit@rabbitmq02 from the cluster
```



### 6.2 rabbitmq docker é›†ç¾¤èŠ‚ç‚¹æ·»åŠ 

```bash
# é›†ç¾¤èŠ‚ç‚¹æ·»åŠ ï¼š
æ·»åŠ èŠ‚ç‚¹ï¼š192.168.13.162ï¼š
docker run -d --restart=always \
--hostname rabbitmq02 \
--name rabbitmq02 \
-v /home/dockerdata/rabbitmq:/var/lib/rabbitmq  \
-p 25672:25672 \
-p 15672:15672 \
-p 5672:5672 \
-p 4369:4369 \
-e RABBITMQ_ERLANG_COOKIE='rabbitcookie@homsom' \
-e RABBITMQ_DEFAULT_USER=admin \
-e RABBITMQ_DEFAULT_PASS=p@ss123.com \
--add-host rabbitmq01:192.168.13.235 \
--add-host rabbitmq03:192.168.13.160 \
rabbitmq:3.8.9-management

[root@linux03 dockerdata]# docker exec -it rabbitmq02 /bin/sh
#rabbitmqctl cluster_status
Cluster status of node rabbit@rabbitmq02 ...
Basics
Cluster name: rabbit@rabbitmq02
#rabbitmqctl stop_app
Stopping rabbit application on node rabbit@rabbitmq02 ...
#rabbitmqctl reset
Resetting node rabbit@rabbitmq02 ...
# rabbitmqctl join_cluster --ram rabbit@rabbitmq01
Clustering node rabbit@rabbitmq02 with rabbit@rabbitmq01
#rabbitmqctl start_app
Starting node rabbit@rabbitmq02 ...
# rabbitmqctl cluster_status
Cluster status of node rabbit@rabbitmq02 ...
Basics
Cluster name: rabbit@rabbitmq01

Disk Nodes
rabbit@rabbitmq01
rabbit@rabbitmq03

RAM Nodes
rabbit@rabbitmq02

Running Nodes
rabbit@rabbitmq01
rabbit@rabbitmq02
rabbit@rabbitmq03
```



### 6.3 rabbitmqå‚æ•°è°ƒæ•´

[docs01](https://www.rabbitmq.com/docs/3.13/configure#supported-environment-variables)
[docs02](https://github.com/rabbitmq/rabbitmq-server/blob/v3.8.9/docs/rabbitmq.conf.example)



#### 6.3.1 åŠ¨æ€è°ƒæ•´

```
# åŠ¨æ€è°ƒæ•´rabbitmqèŠ‚ç‚¹çš„å†…å­˜é™åˆ¶å¤§å°
# å†…å­˜é™åˆ¶: é€šè¿‡ vm_memory_high_watermark è®¾ç½®ï¼Œåˆç†è°ƒæ•´å†…å­˜å ç”¨æ¯”ä¾‹å¯ä»¥é¿å… RabbitMQ å› å†…å­˜æº¢å‡ºè€Œå‡ºç°é—®é¢˜ã€‚
rabbitmqctl set_vm_memory_high_watermark 0.6

# åŠ¨æ€è°ƒæ•´rabbitmqèŠ‚ç‚¹çš„ç£ç›˜å¯ç”¨ç©ºé—´é™åˆ¶å¤§å°ï¼Œå½“å°äºæ­¤å€¼æ—¶ï¼Œrabbitmqæ•´ä¸ªé›†ç¾¤å°†ä¸å¯ç”¨ï¼Œå› æ­¤æ­¤å€¼æ˜¯è¶Šå°è¶Šå¥½ï¼Œé¿å…é¢‘ç¹è§¦å‘
# ç£ç›˜ç©ºé—´é™åˆ¶: é€šè¿‡ disk_free_limit åŠ¨æ€é…ç½®ï¼Œç¡®ä¿ç£ç›˜ç©ºé—´ä¸è¶³æ—¶ RabbitMQ ä¸ä¼šè¿›ä¸€æ­¥å ç”¨ç£ç›˜èµ„æºã€‚è®¾ç½® disk_free_limit ä¸º 48MB å¹¶ä¸ä¼šé€ æˆé—®é¢˜ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç”¨äºé˜²æ­¢ç£ç›˜ç©ºé—´è€—å°½çš„ä¿æŠ¤æœºåˆ¶ã€‚
rabbitmqctl set_disk_free_limit 1GB
#rabbitmqctl set_disk_free_limit 10%

# æ–‡ä»¶æè¿°ç¬¦å’Œå¥—æ¥å­—æè¿°ç¬¦: å¯ä»¥é€šè¿‡æ“ä½œç³»ç»Ÿçš„ ulimit å‘½ä»¤è°ƒæ•´ï¼Œåœ¨dockerä¸­åªèƒ½é€šè¿‡å®¿ä¸»æœºæ“ä½œç³»ç»Ÿçš„ulimitå‘½ä»¤å’Œdockerä¸­çš„rabbitmq.confé…ç½®æ–‡ä»¶è¿›è¡Œæ›´æ”¹


# Erlang è¿›ç¨‹çš„é™åˆ¶:é€šè¿‡å†…å­˜å’Œç³»ç»Ÿèµ„æºçš„åˆ†é…åŠ¨æ€ç®¡ç†ï¼Œé€‚æ—¶å¢åŠ å†…å­˜å’Œè°ƒæ•´é«˜æ°´ä½é™åˆ¶å¯ä»¥æ§åˆ¶è¿›ç¨‹æ•°é‡ï¼Œrabbitmqè‡ªåŠ¨è°ƒæ•´


```



#### 6.3.1 é™æ€è°ƒæ•´

```
# å®šå…¥é…ç½®æ–‡ä»¶/etc/rabbitmq/rabbitmq.confï¼Œå¹¶é‡å¯rabbitmqæœåŠ¡

# file_descriptor_limit = 65536
vm_memory_high_watermark.relative = 0.4
# vm_memory_high_watermark.absolute = 2GB
disk_free_limit.absolute = 500mb
```



### 6.4 å®¿ä¸»æœºulimitè°ƒæ•´åï¼Œdockerå®¹å™¨ä¸­å€¼è¿˜æœªæ”¹å˜ï¼Œå¦‚ä½•è°ƒæ•´å®¹å™¨ulimit

```bash
[root@test ~]# docker stop rabbit
[root@test ~]# docker rm -fv rabbit
[root@test ~]# docker run -d --restart=always \
--hostname rabbit \
--name rabbit \
--ulimit nofile=80000:80000 \
-v /data/rabbitmq:/var/lib/rabbitmq  \
-p 25672:25672 \
-p 15672:15672 \
-p 5672:5672 \
-p 4369:4369 \
-e RABBITMQ_ERLANG_COOKIE='test666666' \
-e RABBITMQ_DEFAULT_USER=admin \
-e RABBITMQ_DEFAULT_PASS=p@ss123.com \
harborrepo.hs.com/ops/rabbitmq:3.8.9-management

[root@test ~]# docker exec rabbit sh -c 'ulimit -n'
80000
```

> --ulimit nofile=80000:80000è®¾ç½®å®¹å™¨å†…çš„æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ä¸º 80000ã€‚æ­¤å‚æ•°è¡¨ç¤ºå®¹å™¨å†…è½¯é™åˆ¶å’Œç¡¬é™åˆ¶éƒ½ä¸º80000

#Saltstack深入
####YAML语法：
简介：YAML语法写成sls描述文件，sls全称：Salt State
<pre>
例子：
apache-install:
  pkg.installed:
    - names:
      - httpd
      - httpd-devel
apache-service:
  service.running:
    - name: httpd
    - enable: True

1. apache-service为名称(ID)声明,不写names,则默认name就是名称声明的名称。ID声明在高级状态下必须唯一
2. service.running为State声明，状态声明，模块声明
3. - name: httpd为名称选项声明

实际应用例子：LAMP架构
1. 安装软件包		pkg
2. 修改配置文件	file
3. 启动服务 		service

pkg.installed	安装
pkg.latest	确保最新版本软件
pkg.remove	卸载
pkg.purge	卸载并删除配置文件

1.同时安装多个包：
common_packages:
  pkg.installed:
    - pkgs:
      - httpd
      - php
      - mysql
      - mariadb-server
      - php-mysql
      - php-cli
      - php-mbstring

2.配置管理
apache-config:
  file.managed:#一个ID声明中只能是不同的状态模块，因为会冲突
    - name: /etc/httpd/conf/httpd.conf #要被配置的文件
    - source: salt://files/httpd.conf #源文件在哪
    - user: root  #文件所有者用户
    - group: root  #文件所有者组
    - mode: 644  #文件权限

php-config:
  file.managed:
    - name: /etc/php.ini
    - source: salt://files/php.ini
    - user: root
    - group: root
    - mode: 644

mysql-config:
   file.managed:
    - name: /etc/my.cnf
    - source: salt://files/my.cnf
    - user: root
    - group: root
    - mode: 644

3.服务管理
apache-service:
  service.running:
    - name: httpd
    - enable: True
    - reload: True

mysql-service:
  service.running:
    - name: mariadb
    - enable: True
    - reload: True
注：salt://这个根目录是当前base环境下的根目录/srv/salt，如果是其他环境时，则寻找其他环境时的根目录

#vim /srv/salt/lamp/lamp.sls
lamp-pkg:
  pkg.installed:
    - pkgs:
      - httpd
      - php
      - mariadb
      - mariadb-server
      - php-mysql
      - php-cli
      - php-mbstring

apache-config:
  file.managed:
    - name: /etc/httpd/conf/httpd.conf
    - source: salt://lamp/files/httpd.conf
    - user: root
    - group: root
    - mode: 644

php-config:
  file.managed:
    - name: /etc/php.ini
    - source: salt://lamp/files/php.ini
    - user: root
    - group: root
    - mode: 644

mysql-config:
   file.managed:
    - name: /etc/my.cnf
    - source: salt://lamp/files/my.cnf
    - user: root
    - group: root
    - mode: 644

apache-service:
  service.running:
    - name: httpd
    - enable: True
    - reload: True

mysql-service:
  service.running:
    - name: mariadb
    - enable: True
    - reload: True

#or
lamp-pkg:
  pkg.installed:
    - pkgs:
      - httpd
      - php
      - mariadb
      - mariadb-server
      - php-mysql
      - php-cli
      - php-mbstring
     
apache-server:
  file.managed:
    - name: /etc/httpd/conf/httpd.conf
    - source: salt://lamp/files/httpd.conf
    - user: root
    - group: root
    - mode: 644
  service.running:
    - name: httpd
    - enable: True
    - reload: True

mysql-server:
   file.managed:
    - name: /etc/my.cnf
    - source: salt://lamp/files/my.cnf
    - user: root
    - group: root
    - mode: 644
  service.running:
    - name: mariadb
    - enable: True
    - reload: True

php-config:
  file.managed:
    - name: /etc/php.ini
    - source: salt://lamp/files/php.ini
    - user: root
    - group: root
    - mode: 644
salt 'linux*' state.sls lamp.lamp

状态间关系：
 1. 我依赖谁    require: 
    require: #我依赖下面两个模块的id是否为True，为True我才能成功执行
      - pkg: lamp-pkg  #pkg是模块名，后面是相关的ID
      - file: apache-config
 2. 我被谁依赖   require_in
    require_in: mysql-service #我被其他模块依赖，我必须先成功执行，其他依赖我的模块才能成功执行
 3. 我监控谁  watch，监控salt://lamp/files/httpd.conf配置文件是否被更改，如果被更改则重载配置文件到各个minion
  - reload: True#写了就是重载配置文件，不写这个就是重启服务 
  - watch:
      - file: apache-config #watch包括require,也就是apache-config首先存在，然后apache-config被更改了才用reload进行重载
 4. 我被谁监控 watch_in
 5. 我引用谁  include
 include: 
   - lamp.mysql
   - lamp.apache
 6. 我扩展谁
编写SLS技巧：
1. 按状态分类，如果单独使用，很清晰
2. 按服务分类，可以被其他的SLS include。例如LNMP的sls include mysql的sls
例：
lamp-pkg:
  pkg.installed:
    - pkgs:
      - httpd
      - php
      - mariadb
      - mariadb-server
      - php-mysql
      - php-cli
      - php-mbstring

apache-config:
  file.managed:
    - name: /etc/httpd/conf/httpd.conf
    - source: salt://lamp/files/httpd.conf
    - user: root
    - group: root
    - mode: 644
    
apache-service:
  service.running:
    - name: httpd
    - enable: True
    - reload: True
    - require:   #依赖关系 
      - pkg: lamp-pkg  
    - watch:
      - file: apache-config
 
mysql-config:
   file.managed:
    - name: /etc/my.cnf
    - source: salt://lamp/files/my.cnf
    - user: root
    - group: root
    - mode: 644
    - require_in: mysql-service
  
mysql-service:
  service.running:
    - name: mariadb
    - enable: True
    - reload: True
</pre>

###Jinja模板(python的模板语言)
<pre>
两种分隔符:
1 {%……%}条件语句
2 {{……}}变量
使用一个模板需要3步走：
1. 告诉File模块，使用Jinja模板，这样jinja格式就可以生效了
- template: jinja
2. 你要列出参数列表
- defaults:
  PORT: 88  #指定PORT变量值为88
3. 模板引用
{{ PORT }} #在source文件中添加jinja格式的变量

例:
apache-config:
  file.managed:
    - name: /etc/httpd/conf/httpd.conf
    - source: salt://lamp/files/httpd.conf
    - user: root
    - group: root
    - mode: 644
    - template: jinja
    - defaults:
      PORT: 99

#jinja模板可以使用：salt grains pillar 赋值

grains目标选择fqdn_ip4这个item是跟minion的主机名绑定的，是唯一的，vim /etc/hosts 后，使用 `salt '*' saltutil.sync_grains` 直接同步即可
FQDN:完全合格域名

一、写在模板文件中
使用grains进行赋值：
Listen {{grains['fqdn_ip4'][0]}}:{{ PORT }}
Salt远程执行模块：
{{ salt['network.hw_addr']('eth0') }}
#一样效果：取eth0的mac地址：salt '*' network.hw_addr eth0
使用pillar赋值：{{ pillar['apache']}}
二、写在SLS文件里面的Defaults变量列表中
- defaults:
    IPADDR: {{ grains['fqdn_ip4'][0] }}
    PORT: 88

混合匹配：and,or,not
戴明环又叫质量环（PDCA(plan do check action)）
yum install lrzsz -y 
rz:上传    sz：下载

salt实战：
首先头脑风暴：
1. 系统初始化
2. 功能模板：设置单独的目录,nginx,php,mysql,memcached,尽可能的全、独立
3. 业务模块：根据业务类型划分，例如web服务。论坛bbs，然后用include包括进来
干活：
salt环境配置：开发、测试（功能测试、性能测试）、预生产、生产
1. base基础环境
init目录，环境初始化（在salt基础上）：1.dns配置，2.history记录时间3.记录命令操作4.内核参数优化5.安装yum仓库6.安装zabbix-agent

2. prod生产环境

步骤：
1. vim /etc/salt/master
file_roots:
  base:
    - /srv/salt/base
  prod:
    - /srv/salt/prod
pillar_roots:
  base:
    - /srv/pillar/base
  prod:
    - /srv/pillar/prod

[root@SaltstackServer /srv/salt]# mkdir base 
[root@SaltstackServer /srv/salt]# mkdir prod
[root@SaltstackServer /srv/pillar]# mkdir base
[root@SaltstackServer /srv/pillar]# mkdir prod
[root@SaltstackServer /srv/pillar]# systemctl restart salt-master.service 
1.base基础环境初始化编写基础模块sls
#dns.sls----dns配置
[root@SaltstackServer /srv/salt/base/init]# cat dns.sls
/etc/resolve.conf:
  file.managed:
    - source: salt://init/files/resolv.conf
    - user: root
    - group: root
    - mode: 644
[root@SaltstackServer /srv/salt/base/init/files]# cat resolv.conf
#history.sls----history记录时间
[root@SaltstackServer /srv/salt/base/init]# cat history.sls 
/etc/profile:
  file.append:
    - text:
      - export HISTTIMEFORMAT="%F %T `whoami`"
#audit.sls----记录命令操作
[root@SaltstackServer /srv/salt/base/init]# cat audit.sls 
/etc/bashrc:
  file.append:
    - text:
      - export PROMPT_COMMAND='{ msg=$(history 1 | { read x y; echo $y; });logger "[euid=$(whoami)]":$(who am i):[`pwd`]"$msg"; }'
#sysctl.sls----内核参数优化
[root@SaltstackServer /srv/salt/base/init]# cat sysctl.sls 
net.ipv4.ip_local_port_range:    #客户端打口随机端口范围
  sysctl.present:
    - value: 10000 65000
fs.file-max:
  sysctl.present:
    - value: 2000000
net.ipv4.ip_forward:     #打开ipv4转发
  sysctl.present:
    - value: 1
vm.swappiness:   #swap为0,尽量不要使用swap内存
  sysctl.present:
    - value: 0
#epel.sls----安装yum仓库
[root@SaltstackServer /srv/salt/base/init]# cat epel.sls 
yum_repo_release:
  pkg.installed:
    - sources:
      - epel-release: https://mirrors.aliyun.com/epel/epel-release-latest-7.noarch.rpm
#zabbix-agent.sls----安装zabbix-agent
[root@SaltstackServer /srv/salt/base/init]# cat zabbix-agent.sls 
zabbix-agent:
  pkg.installed:
    - name: zabbix-agent
  file.managed:
    - name: /etc/zabbix/zabbix_agentd.conf
    - source: salt://init/files/zabbix_agentd.conf
    - template: jinja
    - defaults:
        Zabbix_Server: {{ pillar['Zabbix_Server'] }}
    - require:
      - pkg: zabbix-agent
  service.running:
    - enable: True
    - watch:
      - pkg: zabbix-agent
      - file: zabbix-agent
zabbix_agentd.conf.d:
  file.directory:
    - name: /etc/zabbix/zabbix_agentd.d
    - watch_in: 
      - service: zabbix-agent
    - require:
      - pkg: zabbix-agent


#[root@SaltstackServer /srv/pillar/base]# vim /srv/salt/base/init/files/zabbix_agentd.conf
Server={{ Zabbix_Server }}

#/srv/pillar/base/zabbix/agent.sls--编写pillar
[root@SaltstackServer /srv/pillar/base]# cat zabbix/agent.sls 
Zabbix_Server: 192.168.1.201
#/srv/pillar/base/top.sls--编写top file
[root@SaltstackServer /srv/pillar/base]# cat top.sls 
base:
  '*':
    - zabbix.agent

#init.sls
[root@SaltstackServer /srv/salt/base/init]# cat init.sls 
include:
  - init.dns
  - init.history
  - init.audit
  - init.sysctl
  - init.epel
  - init.zabbix-agent

#top.sls
[root@SaltstackServer /srv/salt/base]# cat top.sls 
base:
  '*':
    - init.init


注意：当你在执行： “salt '*' state.sls init.zabbix-agent ” 时，总共有两个机器，一个机器能执行成功，一个则报错  “ Specified SLS 'zabbix.agent' in environment 'base' is not available on the salt master ”，而这个机器正好是slat-master,实践得出，在salt-master上pillar的base环境下，不能有zabbix.agent这个模块，因为对关键字敏感，最终我把zabbix.agent改成zb.agent后，在使用“salt '*' saltutil.refresh_pillar”同步pillar后可以执行成功

层级关系：
[root@SaltstackServer /srv/salt/base]# tree
.
├── init
│?? ├── audit.sls
│?? ├── dns.sls
│?? ├── epel.sls
│?? ├── files
│?? │?? ├── resolv.conf
│?? │?? └── zabbix_agentd.conf
│?? ├── history.sls
│?? ├── init.sls
│?? ├── sysctl.sls
│?? └── zabbix-agent.sls
└── top.sls
[root@SaltstackServer /srv/salt/base]# salt '*' state.show_top
SaltstackServer.com:
    ----------
    base:
        - init.init
linux-node1:
    ----------
    base:
        - init.init
[root@SaltstackServer /srv/salt/base]# salt '*' state.highstate  --执行高级状态


##haproxy部署
[root@SaltstackServer /srv/salt/prod]# tree

├── cluster
│   ├── files
│   │   ── haproxy-outside.cfg.template
│   └── haproxy-outside.sls
└── modules
    ├── haproxy
    │   ├── files
    │   │   ├── haproxy-1.9.0.tar.gz
    │   │   └── haproxy.init
    │   └── install.sls
    ├── keepalived
    ├── libevent
    ├── memcached
    ├── nginx
    ├── php
    ├── pkg
         ── make.sls


--------------------------------------------------------------
[root@SaltstackServer /srv/salt/prod/modules/pkg]# cat make.sls
make-pkg:
  pkg.installed:
    - pkgs:
      - gcc
      - gcc-c++
      - glibc
      - make
      - autoconf
      - openssl
      - openssl-devel
      - pcre
      - pcre-devel
---------------------------------------------------------------
[root@SaltstackServer /srv/salt/prod/modules/haproxy]# cat install.sls
include:
  - modules.pkg.make

haproxy-install:
  file.managed:
    - name: /usr/local/src/haproxy-1.9.0.tar.gz
    - source: salt://modules/haproxy/files/haproxy-1.9.0.tar.gz
    - mode: 755
    - user: root
    - group: root
  cmd.run:
    - name: cd /usr/local/src && tar -zxf haproxy-1.9.0.tar.gz && cd haproxy-1.9.0 && make TARGET=linux2628 PREFIX=/usr/local/haproxy-1.9.0 && make install PREF                                                                                                                IX=/usr/local/haproxy-1.9.0 && ln -s /usr/local/haproxy-1.9.0 /usr/local/haproxy
    - unless: test -L /usr/local/haproxy
    - require:
      - pkg: make-pkg
      - file: haproxy-install
haproxy-init:
  file.managed:
    - name: /etc/init.d/haproxy
    - source: salt://modules/haproxy/files/haproxy.init
    - mode: 755
    - user: root
    - group: root
    - require_in:
      - file: haproxy-install
  cmd.run:
    - name: chkconfig --add haproxy
    - unless: chkconfig --list | grep haproxy

net.ipv4.ip_nonlocal_bind:
  sysctl.present:
    - value: 1
/etc/haproxy:
  file.directory:
    - user: root
    - group: root
    - mode: 755
-------------------------------------------------------------
[root@SaltstackServer /srv/salt/prod/modules/haproxy/files]# cat haproxy.init
#!/bin/sh
#
# chkconfig: - 85 15
# description: HA-Proxy is a TCP/HTTP reverse proxy which is particularly suited \
#              for high availability environments.
# processname: haproxy
# config: /etc/haproxy/haproxy.cfg
# pidfile: /var/run/haproxy.pid

# Script Author: Simon Matter <simon.matter@invoca.ch>
# Version: 2004060600

# Source function library.
if [ -f /etc/init.d/functions ]; then
  . /etc/init.d/functions
elif [ -f /etc/rc.d/init.d/functions ] ; then
  . /etc/rc.d/init.d/functions
else
  exit 0
fi

# Source networking configuration.
. /etc/sysconfig/network

# Check that networking is up.
[ ${NETWORKING} = "no" ] && exit 0

# This is our service name
BASENAME=`basename $0`
if [ -L $0 ]; then
  BASENAME=`find $0 -name $BASENAME -printf %l`
  BASENAME=`basename $BASENAME`
fi

BIN=/usr/local/haproxy/sbin/$BASENAME

CFG=/etc/$BASENAME/$BASENAME.cfg
[ -f $CFG ] || exit 1

PIDFILE=/var/run/$BASENAME.pid
LOCKFILE=/var/lock/subsys/$BASENAME

RETVAL=0

start() {
  quiet_check
  if [ $? -ne 0 ]; then
    echo "Errors found in configuration file, check it with '$BASENAME check'."
    return 1
  fi

  echo -n "Starting $BASENAME: "
  daemon $BIN -D -f $CFG -p $PIDFILE
  RETVAL=$?
  echo
  [ $RETVAL -eq 0 ] && touch $LOCKFILE
  return $RETVAL
}

stop() {
  echo -n "Shutting down $BASENAME: "
  killproc $BASENAME -USR1
  RETVAL=$?
  echo
  [ $RETVAL -eq 0 ] && rm -f $LOCKFILE
  [ $RETVAL -eq 0 ] && rm -f $PIDFILE
  return $RETVAL
}

restart() {
  quiet_check
  if [ $? -ne 0 ]; then
    echo "Errors found in configuration file, check it with '$BASENAME check'."
    return 1
  fi
  stop
  start
}

reload() {
  if ! [ -s $PIDFILE ]; then
    return 0
  fi

  quiet_check
  if [ $? -ne 0 ]; then
    echo "Errors found in configuration file, check it with '$BASENAME check'."
    return 1
  fi
  $BIN -D -f $CFG -p $PIDFILE -sf $(cat $PIDFILE)
}

check() {
  $BIN -c -q -V -f $CFG
}

quiet_check() {
  $BIN -c -q -f $CFG
}

rhstatus() {
  status $BASENAME
}

condrestart() {
  [ -e $LOCKFILE ] && restart || :
}

# See how we were called.
case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  restart)
    restart
    ;;
  reload)
    reload
    ;;
  condrestart)
    condrestart
    ;;
  status)
    rhstatus
    ;;
  check)
    check
    ;;
  *)
    echo $"Usage: $BASENAME {start|stop|restart|reload|condrestart|status|check}"
    exit 1
esac

exit $?
-----------------------------------------------------------
[root@SaltstackServer /srv/salt/prod/cluster]# cat haproxy-outside.sls
include:
  - modules.haproxy.install

haproxy-service:
  file.managed:
    - name: /etc/haproxy/haproxy.cfg
    - source: salt://cluster/files/haproxy-outside.cfg.template
    - user: root
    - group: root
    - mode: 644
  service.running:
    - name: haproxy
    - enable: True
    - reload: True
    - require:
      - cmd: haproxy-install
    - watch:
      - file: haproxy-service
--------------------------------------------------------------------------
[root@SaltstackServer /srv/salt/prod/cluster/files]# cat haproxy-outside.cfg.template
global
maxconn 100000
chroot /usr/local/haproxy
uid 99
gid 99
daemon
nbproc 1
pidfile /usr/local/haproxy/logs/haproxy.pid
log 127.0.0.1 local3 info

#默认参数设置
defaults
option http-keep-alive
maxconn 100000
mode http
timeout connect 5000ms
timeout client  50000ms
timeout server 50000ms

#开启Haproxy Status状态监控，增加验证
listen stats
mode http
bind 0.0.0.0:8888
stats enable
stats uri     /haproxy-status
stats auth    haproxy:saltstack

#前端设置
frontend frontend_www_example_com
bind 192.168.1.236:80
mode http
option httplog
log global
    default_backend backend_www_example_com

#后端设置
backend backend_www_example_com
option forwardfor header X-REAL-IP
option httpchk HEAD / HTTP/1.0
balance source
server web-node1  192.168.1.231:8080 check inter 2000 rise 30 fall 15
server web-node2  192.168.1.232:8080 check inter 2000 rise 30 fall 15
---------------------------------------------------------


##keepalived部署：
[root@SaltstackServer /srv/salt/prod]# tree
.
├── cluster
│   ├── files
│   │   ├── haproxy-outside.cfg.template
│   │   └── haproxy-outside-keepalived.conf
│   ├── haproxy-outside-keepalived.sls
│   └── haproxy-outside.sls
└── modules
    ├── haproxy
    │   ├── files
    │   │   ├── haproxy-1.9.0.tar.gz
    │   │   └── haproxy.init
    │   └── install.sls
    ├── keepalived
    │   ├── files
    │   │   ├── keepalived-1.2.17.tar.gz
    │   │   ├── keepalived.init
    │   │   └── keepalived.sysconfig
    │   └── install.sls
    ├── libevent
    ├── nginx
    ├── php
    ├── pkg
        └── make.sls

---------------------------------------------------------
[root@SaltstackServer /srv/salt/prod/modules/keepalived]# cat install.sls
{% set keepalived_tar= 'keepalived-1.2.17.tar.gz'  %}
{% set keepalived_source= 'salt://modules/keepalived/files/'  %}

keepalived-install:
  file.managed:
    - name: /usr/local/src/{{ keepalived_tar }}
    - source: {{ keepalived_source }}{{ keepalived_tar }}
    - mode: 755
    - user: root
    - group: root
  cmd.run:
    - name: cd /usr/local/src && tar zxf {{  keepalived_tar }} && cd keepalived-1.2.17 && ./configure --prefix=/usr/local/keepalived --disable-fwmark && make && make install
    - unless: test -d /usr/local/keepalived
    - require:
      - file: keepalived-install

/etc/sysconfig/keepalived:
  file.managed:
    - source: {{ keepalived_source }}keepalived.sysconfig
    - mode: 644
    - user: root
    - group: root

/etc/init.d/keepalived:
  file.managed:
    - source: {{ keepalived_source }}keepalived.init
    - mode: 755
    - user: root
    - group: root

keepalived-init:
  cmd.run:
    - name: chkconfig --add keepalived
    - unless: chkconfig --list | grep keepalived
    - require:
      - file: /etc/init.d/keepalived

/etc/keepalived:
  file.directory:
    - user: root
    - group: root

---------------------------------------------------------
[root@SaltstackServer /srv/salt/prod/modules/keepalived]# cat files/keepalived.sysconfig
# Options for keepalived. See `keepalived --help' output and keepalived(8) and
# keepalived.conf(5) man pages for a list of all options. Here are the most
# common ones :
#
# --vrrp               -P    Only run with VRRP subsystem.
# --check              -C    Only run with Health-checker subsystem.
# --dont-release-vrrp  -V    Dont remove VRRP VIPs & VROUTEs on daemon stop.
# --dont-release-ipvs  -I    Dont remove IPVS topology on daemon stop.
# --dump-conf          -d    Dump the configuration data.
# --log-detail         -D    Detailed log messages.
# --log-facility       -S    0-7 Set local syslog facility (default=LOG_DAEMON)
#

KEEPALIVED_OPTIONS="-D"
---------------------------------------------------------   
[root@SaltstackServer /srv/salt/prod/modules/keepalived]# cat files/keepalived.init
#!/bin/sh
#
# Startup script for the Keepalived daemon
#
# processname: keepalived
# pidfile: /var/run/keepalived.pid
# config: /etc/keepalived/keepalived.conf
# chkconfig: - 21 79
# description: Start and stop Keepalived

# Source function library
. /etc/rc.d/init.d/functions

# Source configuration file (we set KEEPALIVED_OPTIONS there)
. /etc/sysconfig/keepalived

RETVAL=0

prog="keepalived"

start() {
    echo -n $"Starting $prog: "
#    daemon keepalived ${KEEPALIVED_OPTIONS}
    daemon /usr/local/keepalived/sbin/keepalived ${KEEPALIVED_OPTIONS}
    RETVAL=$?
    echo
    [ $RETVAL -eq 0 ] && touch /var/lock/subsys/$prog
}

stop() {
    echo -n $"Stopping $prog: "
    killproc keepalived
    RETVAL=$?
    echo
    [ $RETVAL -eq 0 ] && rm -f /var/lock/subsys/$prog
}

reload() {
    echo -n $"Reloading $prog: "
    killproc keepalived -1
    RETVAL=$?
    echo
}

# See how we were called.
case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    reload)
        reload
        ;;
    restart)
        stop
        start
        ;;
    condrestart)
        if [ -f /var/lock/subsys/$prog ]; then
            stop
            start
        fi
        ;;
    status)
        status keepalived
        RETVAL=$?
        ;;
    *)
        echo "Usage: $0 {start|stop|reload|restart|condrestart|status}"
        RETVAL=1
esac

exit $RETVAL
---------------------------------------------------------
[root@SaltstackServer /srv/salt/prod/cluster]# cat haproxy-outside-keepalived.sls
include:
  - modules.keepalived.install

keepalived-server:
  file.managed:
    - name: /etc/keepalived/keepalived.conf
    - source: salt://cluster/files/haproxy-outside-keepalived.conf
    - mode: 644
    - user: root
    - group: root
    - template: jinja
    {% if grains['fqdn'] == 'Linux-node3-salt' %}
    - ROUTEID: haproxy_ha
    - STATEID: MASTER
    - PRIORITYID: 150
    {% elif grains['fqdn'] == 'Linux-node4-salt' %}
    - ROUTEID: haproxy_ha
    - STATEID: BACKUP
    - PRIORITYID: 100
    {% endif %}
  service.running:
    - name: keepalived
    - enable: True
    - watch:
      - file: keepalived-server
---------------------------------------------------------
[root@SaltstackServer /srv/salt/prod/cluster/files]# cat haproxy-outside-keepalived.conf
! Configuration File for keepalived
global_defs {
   notification_email {
     saltstack@example.com
   }
   notification_email_from keepalived@example.com
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id {{ROUTEID}}
}

vrrp_instance haproxy_ha {
state {{STATEID}}
interface eth0
    virtual_router_id 36
priority {{PRIORITYID}}
    advert_int 1
authentication {
auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
       192.168.1.236
    }
}

---------------------------------------------------------
[root@SaltstackServer /srv/salt/base]# cat top.sls
base:
  '*':
    - init.init
prod:
  'Linux-node3*':
    - cluster.haproxy-outside
    - cluster.haproxy-outside-keepalived
  'Linux-node4*':
    - cluster.haproxy-outside
    - cluster.haproxy-outside-keepalived
---------------------------------------------------------
[root@SaltstackServer /srv/salt/prod/cluster/files]# salt '*' state.highstate

##memcached部署
1. session保持
2. session复制
3. session共享（php把session写到memcached上，session用于唯一标识，php与可以写入到redis，但memcached单纯的写和读优于redis）
[root@salt-server /srv/salt/prod]# tree
.
├── bbs
│?? └── memcached.sls
├── cluster
│?? ├── files
│?? │?? ├── haproxy-outside.cfg.template
│?? │?? └── haproxy-outside-keepalived.conf
│?? ├── haproxy-outside-keepalived.sls
│?? └── haproxy-outside.sls
└── modules
    ├── haproxy
    │?? ├── files
    │?? │?? ├── haproxy-1.9.0.tar.gz
    │?? │?? └── haproxy.init
    │?? └── install.sls
    ├── keepalived
    │?? ├── files
    │?? │?? ├── keepalived-1.2.17.tar.gz
    │?? │?? ├── keepalived.init
    │?? │?? └── keepalived.sysconfig
    │?? └── install.sls
    ├── libevent
    │?? ├── files
    │?? │?? └── libevent-2.0.22-stable.tar.gz
    │?? └── install.sls
    ├── memcached
    │?? ├── files
    │?? │?? └── memcached-1.4.24.tar.gz
    │?? └── install.sls
    ├── nginx
    ├── php
    ├── pkg
    │?? └── make.sls
    └── user
        └── www.sls
------------------------------------------------------------
[root@salt-server /srv/salt/prod]# cat modules/user/www.sls 
www-user-group:
  group.present:
    - name: www
    - gid: 1000

  user.present:
    - name: www
    - fullname: www
    - shell: /sbin/nologin
    - uid: 1000
    - gid: 1000
------------------------------------------------------------
[root@salt-server /srv/salt/prod]# cat modules/libevent/install.sls 
libevent-source-install:
  file.managed:
    - name: /usr/local/src/libevent-2.0.22-stable.tar.gz
    - source: salt://modules/libevent/files/libevent-2.0.22-stable.tar.gz
    - user: root
    - group: root
    - mode: 644
  cmd.run:
    - name: cd /usr/local/src && tar zxf libevent-2.0.22-stable.tar.gz && cd libevent-2.0.22-stable &&  ./configure --prefix=/usr/local/libevent && make && make install
    - unless: test -d /usr/local/libevent
    - require:
      - file: libevent-source-install
------------------------------------------------------------
[root@salt-server /srv/salt/prod]# cat modules/memcached/install.sls 
include:
  - modules.libevent.install

memcached-source-install:
  file.managed:
    - name: /usr/local/src/memcached-1.4.24.tar.gz
    - source: salt://modules/memcached/files/memcached-1.4.24.tar.gz
    - user: root
    - group: root
    - mode: 644
  cmd.run:
    - name: cd /usr/local/src && tar zxf memcached-1.4.24.tar.gz && cd memcached-1.4.24&& ./configure --prefix=/usr/local/memcached --enable-64bit --with-libevent=/usr/local/libevent && make && make install
    - unless: test -d /usr/local/memcached
    - require:
      - cmd: libevent-source-install
      - file: memcached-source-install
------------------------------------------------------------
[root@salt-server /srv/salt/prod]# cat bbs/memcached.sls 
include:
  - modules.memcached.install
  - modules.user.www

memcached-service:
  cmd.run:
    - name: /usr/local/memcached/bin/memcached -d -m 128 -p 11211 -c 8096 -u www
    - unless: netstat -ntlp | grep 11211
    - require:
      - cmd: memcached-source-install
      - user: www-user-group
------------------------------------------------------------      
注：memcached没有配置文件，memcached只能关闭或重启，不能重载，只要重新启动就可以了，
memcached安装时先要安装libevent软件 
------------------------------------------------------------ 
[root@salt-server /srv/salt/base]# cat top.sls 
base:
  '*':
    - init.init
prod:
  'Linux-node3*':
    - cluster.haproxy-outside
    - cluster.haproxy-outside-keepalived
  'Linux-node4*':
    - cluster.haproxy-outside
    - cluster.haproxy-outside-keepalived
    - bbs.memcached
------------------------------------------------------------ 
[root@salt-server /srv/salt/base]# salt '*' state.highstate

##nginx+php配置
#salt-run命令：
salt '*' saltutil.runnig  #查看正在运行的job_id
salt '*' saltutil.kill_job job_id  #结束job_id的工作
注：当你ctrl+c时，salt还在运行，所以你要用salt '*' saltutil.kill_job job_id来结束不需要的salt工作，用sal-run jobs.lookup_id 2016...  查看详细的job_id工作

------------------------------------------------------------
[root@salt-server /srv/salt/prod]# tree
.
├── bbs
│?? ├── files
│?? │?? ├── nginx-bbs.conf
│?? │?? ├── php-fpm.conf.default
│?? │?? └── php.ini-production
│?? ├── memcached.sls
│?? └── web.sls
├── cluster
│?? ├── files
│?? │?? ├── haproxy-outside.cfg.template
│?? │?? └── haproxy-outside-keepalived.conf
│?? ├── haproxy-outside-keepalived.sls
│?? └── haproxy-outside.sls
└── modules
    ├── haproxy
    │?? ├── files
    │?? │?? ├── haproxy-1.9.0.tar.gz
    │?? │?? └── haproxy.init
    │?? └── install.sls
    ├── keepalived
    │?? ├── files
    │?? │?? ├── keepalived-1.2.17.tar.gz
    │?? │?? ├── keepalived.init
    │?? │?? └── keepalived.sysconfig
    │?? └── install.sls
    ├── libevent
    │?? ├── files
    │?? │?? └── libevent-2.0.22-stable.tar.gz
    │?? └── install.sls
    ├── memcached
    │?? ├── files
    │?? │?? └── memcached-1.4.24.tar.gz
    │?? └── install.sls
    ├── nginx
    │?? ├── files
    │?? │?? ├── nginx-1.9.1.tar.gz
    │?? │?? ├── nginx.conf
    │?? │?? └── nginx-init
    │?? ├── install.sls
    │?? └── service.sls
    ├── pcre
    │?? ├── files
    │?? │?? └── pcre-8.37.tar.gz
    │?? └── install.sls
    ├── php
    │?? ├── files
    │?? │?? ├── init.d.php-fpm
    │?? │?? ├── memcache-2.2.7.tgz
    │?? │?? ├── php-5.6.9.tar.gz
    │?? │?? └── phpredis-2.2.7.tgz
    │?? ├── install.sls
    │?? ├── php-memcache.sls
    │?? └── php-redis.sls
    ├── pkg
    │?? └── make.sls
    └── user
        └── www.sls

------------------------------------------------------------
##1.php部署
------------------------------------------------------------
[root@salt-server /srv/salt/prod/modules/php]# cat install.sls 
include:
  - modules.pkg.make
  - modules.user.www

pkg-php:
  pkg.installed:
    - names:
      - mariadb-devel
      - swig
      - libjpeg-turbo
      - libjpeg-turbo-devel
      - libpng
      - libpng-devel
      - freetype
      - freetype-devel
      - libxml2
      - libxml2-devel
      - zlib
      - zlib-devel
      - libcurl
      - libcurl-devel

php-source-install:
  file.managed:
    - name: /usr/local/src/php-5.6.9.tar.gz
    - source: salt://modules/php/files/php-5.6.9.tar.gz
    - user: root
    - group: root
    - mode: 755

  cmd.run:
    - name: cd /usr/local/src && tar zxf php-5.6.9.tar.gz && cd php-5.6.9&&  ./configure --prefix=/usr/local/php-fastcgi --with-pdo-mysql=mysqlnd --with-mysqli=mysqlnd --with-mysql=mysqlnd --with-jpeg-dir --with-png-dir --with-zlib --enable-xml  --with-libxml-dir --with-curl --enable-bcmath --enable-shmop --enable-sysvsem  --enable-inline-optimization --enable-mbregex --with-openssl --enable-mbstring --with-gd --enable-gd-native-ttf --with-freetype-dir=/usr/lib64 --with-gettext=/usr/lib64 --enable-sockets --with-xmlrpc --enable-zip --enable-soap --disable-debug --enable-opcache --enable-zip --with-config-file-path=/usr/local/php-fastcgi/etc --enable-fpm --with-fpm-user=www --with-fpm-group=www && make && make install
    - require:
      - file: php-source-install
      - user: www-user-group
      - pkg: make-pkg
    - unless: test -d /usr/local/php-fastcgi

pdo-plugin:
  cmd.run:
    - name: cd /usr/local/src/php-5.6.9/ext/pdo_mysql/ && /usr/local/php-fastcgi/bin/phpize && ./configure --with-php-config=/usr/local/php-fastcgi/bin/php-config &&  make&& make install
    - unless: test -f /usr/local/php-fastcgi/lib/php/extensions/*/pdo_mysql.so
    - require:
      - cmd: php-source-install

php-fastcgi-service:
  file.managed:
    - name: /etc/init.d/php-fpm
    - source: salt://modules/php/files/init.d.php-fpm
    - user: root
    - group: root
    - mode: 755
  cmd.run:
    - name: chkconfig --add php-fpm
    - unless: chkconfig --list | grep php-fpm
    - require:
      - file: php-fastcgi-service
  
------------------------------------------------------------
[root@salt-server /srv/salt/prod/modules/php]# cat php-memcache.sls 
memcache-plugin:
  file.managed:
    - name: /usr/local/src/memcache-2.2.7.tgz  #memecache插件，并不是memcache软件
    - source: salt://modules/php/files/memcache-2.2.7.tgz
    - user: root
    - group: root
    - mode: 755

  cmd.run:
    - name: cd /usr/local/src && tar zxf memcache-2.2.7.tgz && cd memcache-2.2.7&& /usr/local/php-fastcgi/bin/phpize && ./configure --enable-memcache --with-php-config=/usr/local/php-fastcgi/bin/php-config &&  make&& make install
    - unless: test -f /usr/local/php-fastcgi/lib/php/extensions/*/memcache.so
  require:
    - file: memcache-plugin
    - cmd: php-install

------------------------------------------------------------
[root@salt-server /srv/salt/prod/modules/php]# cat php-redis.sls 
redis-plugin:
  file.managed:
    - name: /usr/local/src/phpredis-2.2.7.tgz
    - source: salt://modules/php/files/phpredis-2.2.7.tgz
    - user: root
    - group: root
    - mode: 755
  cmd.run:
    - name: cd /usr/local/src && tar zxf phpredis-2.2.7.tgz && mv redis-2.2.7 phpredis-2.2.7 && cd phpredis-2.2.7&& /usr/local/php-fastcgi/bin/phpize && ./configure --with-php-config=/usr/local/php-fastcgi/bin/php-config &&  make&& make install
    - unless: test -f /usr/local/php-fastcgi/lib/php/extensions/*/redis.so
  require:
    - file: redis-plugin
    - cmd: php-install

------------------------------------------------------------
[root@salt-server /srv/salt/prod/modules/php/files]# cat init.d.php-fpm 
#! /bin/sh

### BEGIN INIT INFO
# Provides:          php-fpm
# Required-Start:    $remote_fs $network
# Required-Stop:     $remote_fs $network
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: starts php-fpm
# Description:       starts the PHP FastCGI Process Manager daemon
### END INIT INFO

prefix=/usr/local/php-fastcgi
exec_prefix=${prefix}

php_fpm_BIN=${exec_prefix}/sbin/php-fpm
php_fpm_CONF=${prefix}/etc/php-fpm.conf
php_fpm_PID=${prefix}/var/run/php-fpm.pid


php_opts="--fpm-config $php_fpm_CONF --pid $php_fpm_PID"


wait_for_pid () {
        try=0

        while test $try -lt 35 ; do

                case "$1" in
                        'created')
                        if [ -f "$2" ] ; then
                                try=''
                                break
                        fi
                        ;;

                        'removed')
                        if [ ! -f "$2" ] ; then
                                try=''
                                break
                        fi
                        ;;
                esac

                echo -n .
                try=`expr $try + 1`
                sleep 1

        done

}

case "$1" in
        start)
                echo -n "Starting php-fpm "

                $php_fpm_BIN --daemonize $php_opts

                if [ "$?" != 0 ] ; then
                        echo " failed"
                        exit 1
                fi

                wait_for_pid created $php_fpm_PID

                if [ -n "$try" ] ; then
                        echo " failed"
                        exit 1
                else
                        echo " done"
                fi
        ;;

        stop)
                echo -n "Gracefully shutting down php-fpm "

                if [ ! -r $php_fpm_PID ] ; then
                        echo "warning, no pid file found - php-fpm is not running ?"
                        exit 1
                fi

                kill -QUIT `cat $php_fpm_PID`

                wait_for_pid removed $php_fpm_PID

                if [ -n "$try" ] ; then
                        echo " failed. Use force-quit"
                        exit 1
                else
                        echo " done"
                fi
        ;;

        status)
                if [ ! -r $php_fpm_PID ] ; then
                        echo "php-fpm is stopped"
                        exit 0
                fi

                PID=`cat $php_fpm_PID`
                if ps -p $PID | grep -q $PID; then
                        echo "php-fpm (pid $PID) is running..."
                else
                        echo "php-fpm dead but pid file exists"
                fi
        ;;

        force-quit)
                echo -n "Terminating php-fpm "

                if [ ! -r $php_fpm_PID ] ; then
                        echo "warning, no pid file found - php-fpm is not running ?"
                        exit 1
                fi

                kill -TERM `cat $php_fpm_PID`

                wait_for_pid removed $php_fpm_PID

                if [ -n "$try" ] ; then
                        echo " failed"
                        exit 1
                else
                        echo " done"
                fi
        ;;

        restart)
                $0 stop
                $0 start
        ;;

        reload)

                echo -n "Reload service php-fpm "

                if [ ! -r $php_fpm_PID ] ; then
                        echo "warning, no pid file found - php-fpm is not running ?"
                        exit 1
                fi

                kill -USR2 `cat $php_fpm_PID`

                echo " done"
        ;;

        *)
                echo "Usage: $0 {start|stop|force-quit|restart|reload|status}"
                exit 1
        ;;

esac
------------------------------------------------------------
[root@salt-server /srv/salt/prod/modules/php/files]# grep -v '^;' php-fpm.conf.default 
[global]
error_log = /tmp/php-fpm.log
[www]
user = www
group = www
listen = /usr/local/php-fastcgi/php-fpm.sock
listen.owner = www
listen.group = www
listen.mode = 0660
pm = dynamic
pm.max_children = 50
pm.start_servers = 20
pm.min_spare_servers = 10
pm.max_spare_servers = 30
pm.max_requests = 50000
------------------------------------------------------------
[root@salt-server /srv/salt/prod/modules/php/files]# grep ^[a-Z1-9] php.ini-production 
engine = On
short_open_tag = Off
asp_tags = Off
precision = 14
output_buffering = 4096
zlib.output_compression = Off
implicit_flush = Off
unserialize_callback_func =
serialize_precision = 17
disable_functions =
disable_classes =
zend.enable_gc = On
expose_php = On
max_execution_time = 30
max_input_time = 60
memory_limit = 128M
error_reporting = E_ALL & ~E_NOTICE
display_errors = Off
display_startup_errors = Off
log_errors = On
log_errors_max_len = 1024
ignore_repeated_errors = Off
ignore_repeated_source = Off
report_memleaks = On
track_errors = Off
html_errors = On
error_log = /tmp/php_errors.log
variables_order = "GPCS"
request_order = "GP"
register_argc_argv = Off
auto_globals_jit = On
post_max_size = 8M
auto_prepend_file =
auto_append_file =
default_mimetype = "text/html"
doc_root =
user_dir =
enable_dl = Off
file_uploads = On
upload_max_filesize = 2M
max_file_uploads = 20
allow_url_fopen = On
allow_url_include = Off
default_socket_timeout = 60
cli_server.color = On
date.timezone = PRC
pdo_mysql.cache_size = 2000
pdo_mysql.default_socket=
SMTP = localhost
smtp_port = 25
mail.add_x_header = On
sql.safe_mode = Off
odbc.allow_persistent = On
odbc.check_persistent = On
odbc.max_persistent = -1
odbc.max_links = -1
odbc.defaultlrl = 4096
odbc.defaultbinmode = 1
ibase.allow_persistent = 1
ibase.max_persistent = -1
ibase.max_links = -1
ibase.timestampformat = "%Y-%m-%d %H:%M:%S"
ibase.dateformat = "%Y-%m-%d"
ibase.timeformat = "%H:%M:%S"
mysql.allow_local_infile = On
mysql.allow_persistent = On
mysql.cache_size = 2000
mysql.max_persistent = -1
mysql.max_links = -1
mysql.default_port =
mysql.default_socket =
mysql.default_host =
mysql.default_user =
mysql.default_password =
mysql.connect_timeout = 60
mysql.trace_mode = Off
mysqli.max_persistent = -1
mysqli.allow_persistent = On
mysqli.max_links = -1
mysqli.cache_size = 2000
mysqli.default_port = 3306
mysqli.default_socket =
mysqli.default_host =
mysqli.default_user =
mysqli.default_pw =
mysqli.reconnect = Off
mysqlnd.collect_statistics = On
mysqlnd.collect_memory_statistics = Off
pgsql.allow_persistent = On
pgsql.auto_reset_persistent = Off
pgsql.max_persistent = -1
pgsql.max_links = -1
pgsql.ignore_notice = 0
pgsql.log_notice = 0
sybct.allow_persistent = On
sybct.max_persistent = -1
sybct.max_links = -1
sybct.min_server_severity = 10
sybct.min_client_severity = 10
bcmath.scale = 0
session.save_handler = files
session.use_strict_mode = 0
session.use_cookies = 1
session.use_only_cookies = 1
session.name = PHPSESSID
session.auto_start = 0
session.cookie_lifetime = 0
session.cookie_path = /
session.cookie_domain =
session.cookie_httponly =
session.serialize_handler = php
session.gc_probability = 1
session.gc_divisor = 1000
session.gc_maxlifetime = 1440
session.referer_check =
session.cache_limiter = nocache
session.cache_expire = 180
session.use_trans_sid = 0
session.hash_function = 0
session.hash_bits_per_character = 5
url_rewriter.tags = "a=href,area=href,frame=src,input=src,form=fakeentry"
mssql.allow_persistent = On
mssql.max_persistent = -1
mssql.max_links = -1
mssql.min_error_severity = 10
mssql.min_message_severity = 10
mssql.compatibility_mode = Off
mssql.secure_connection = Off
tidy.clean_output = Off
soap.wsdl_cache_enabled=1
soap.wsdl_cache_dir="/tmp"
soap.wsdl_cache_ttl=86400
soap.wsdl_cache_limit = 5
ldap.max_links = -1
opcache.enable=1
extension=pdo_mysql.so
extension=memcache.so
extension=redis.so

------------------------------------------------------------
#nginx部署
------------------------------------------------------------
--nginx组件pcre
[root@salt-server /srv/salt/prod/modules/pcre]# cat install.sls 
pcre-source-install:
  file.managed:
    - name: /usr/local/src/pcre-8.37.tar.gz
    - source: salt://modules/pcre/files/pcre-8.37.tar.gz
    - user: root
    - group: root
    - mode: 755
  cmd.run:
    - name: cd /usr/local/src && tar zxf pcre-8.37.tar.gz && cd pcre-8.37 && ./configure --prefix=/usr/local/pcre && make && make install
    - unless: test -d /usr/local/pcre
    - require:
      - file: pcre-source-install
------------------------------------------------------------
[root@salt-server /srv/salt/prod/modules/nginx]# cat install.sls 
include:
  - modules.user.www
  - modules.pcre.install  #安装pcre，后面有程序会用到这个包
nginx-source-install:
  file.managed:
    - name: /usr/local/src/nginx-1.9.1.tar.gz
    - source: salt://modules/nginx/files/nginx-1.9.1.tar.gz
    - user: root
    - group: root
    - mode: 755
  cmd.run:
    - name: cd /usr/local/src && tar zxf nginx-1.9.1.tar.gz && cd nginx-1.9.1&& ./configure --prefix=/usr/local/nginx --user=www --group=www --with-http_ssl_module --with-http_stub_status_module --with-file-aio --with-http_dav_module --with-pcre=/usr/local/src/pcre-8.37 && make && make install && chown -R www:www /usr/local/nginx
    - unless: test -d /usr/local/nginx
    - require:
      - user: www-user-group
      - file: nginx-source-install
      - cmd: pcre-source-install 
------------------------------------------------------------
[root@salt-server /srv/salt/prod/modules/nginx]# cat service.sls 
include:
  - modules.nginx.install

nginx-init:
  file.managed:
    - name: /etc/init.d/nginx
    - source: salt://modules/nginx/files/nginx-init
    - mode: 755
    - user: root
    - group: root
  cmd.run:
    - name: chkconfig --add nginx
    - unless: chkconfig --list | grep nginx
    - require:
      - file: nginx-init

/usr/local/nginx/conf/nginx.conf:
  file.managed:
    - source: salt://modules/nginx/files/nginx.conf
    - user: www
    - group: www
    - mode: 644 

nginx-service:
  service.running:
    - name: nginx
    - enable: True
    - reload: True
    - require:
      - cmd: nginx-init
    - watch:
      - file: /usr/local/nginx/conf/nginx.conf
      - file: nginx-online

nginx-online:
  file.directory:
    - name: /usr/local/nginx/conf/vhost_online

nginx-offline:
  file.directory:
    - name: /usr/local/nginx/conf/vhost_offline
------------------------------------------------------------
[root@salt-server /srv/salt/prod/modules/nginx]# cat files/nginx.conf 
user  www;
worker_processes  16;
error_log  logs/error.log  error;
worker_rlimit_nofile 30000;
pid        logs/nginx.pid;
events {
    use epoll;
    worker_connections  65535;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile    on;
    tcp_nopush  on;
    underscores_in_headers on;
    keepalive_timeout  10;
       send_timeout 60;
include /usr/local/nginx/conf/vhost_online/*.conf;
server {
                listen         8080;
                server_name 127.0.0.1;
        location /nginx_status {
                stub_status on;
                access_log off;
                allow 127.0.0.1;
                deny all;
                }
        }
}
------------------------------------------------------------
[root@salt-server /srv/salt/prod/modules/nginx]# cat files/nginx-init 
#!/bin/sh
#
# nginx - this script starts and stops the nginx daemon
#
# chkconfig:   - 85 15 
# description:  Nginx is an HTTP(S) server, HTTP(S) reverse \
#               proxy and IMAP/POP3 proxy server
# processname: nginx
# config:      /usr/local/nginx/conf/nginx.conf  //这里虽说是#号开头，但是nginx还会去这个路径找配置文件
# pidfile:     /usr/local/nginx/logs/nginx.pid   //这里虽说是#号开头，但是nginx还会去这个路径找pid
 
# Source function library.
. /etc/rc.d/init.d/functions
 
# Source networking configuration.
. /etc/sysconfig/network
 
# Check that networking is up.
[ "$NETWORKING" = "no" ] && exit 0
 
nginx="/usr/local/nginx/sbin/nginx"
prog=$(basename $nginx)
 
NGINX_CONF_FILE="/usr/local/nginx/conf/nginx.conf"
 
[ -f /etc/sysconfig/nginx ] && . /etc/sysconfig/nginx
 
lockfile=/var/lock/subsys/nginx
 
make_dirs() {
   # make required directories
   user=`$nginx -V 2>&1 | grep "configure arguments:" | sed 's/[^*]*--user=\([^ ]*\).*/\1/g' -`
   if [ -z "`grep $user /etc/passwd`" ]; then
       useradd -M -s /bin/nologin $user
   fi
   options=`$nginx -V 2>&1 | grep 'configure arguments:'`
   for opt in $options; do
       if [ `echo $opt | grep '.*-temp-path'` ]; then
           value=`echo $opt | cut -d "=" -f 2`
           if [ ! -d "$value" ]; then
               # echo "creating" $value
               mkdir -p $value && chown -R $user $value
           fi
       fi
   done
}
 
start() {
    [ -x $nginx ] || exit 5
    [ -f $NGINX_CONF_FILE ] || exit 6
    make_dirs
    echo -n $"Starting $prog: "
    daemon $nginx -c $NGINX_CONF_FILE
    retval=$?
    echo
    [ $retval -eq 0 ] && touch $lockfile
    return $retval
}
 
stop() {
    echo -n $"Stopping $prog: "
    killproc $prog -QUIT
    retval=$?
    echo
    [ $retval -eq 0 ] && rm -f $lockfile
    return $retval
}
 
restart() {
    configtest || return $?
    stop
    sleep 1
    start
}
 
reload() {
    configtest || return $?
    echo -n $"Reloading $prog: "
    $nginx -s reload
    RETVAL=$?
    echo
}
 
force_reload() {
    restart
}
 
configtest() {
  $nginx -t -c $NGINX_CONF_FILE
}
 
rh_status() {
    status $prog
}
 
rh_status_q() {
    rh_status >/dev/null 2>&1
}
 
case "$1" in
    start)
        rh_status_q && exit 0
        $1
        ;;
    stop)
        rh_status_q || exit 0
        $1
        ;;
    restart|configtest)
        $1
        ;;
    reload)
        rh_status_q || exit 7
        $1
        ;;
    force-reload)
        force_reload
        ;;
    status)
        rh_status
        ;;
    condrestart|try-restart)
        rh_status_q || exit 0
            ;;
    *)
        echo $"Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest}"
        exit 2
esac
------------------------------------------------------------
[root@salt-server /srv/salt/prod/bbs]# cat files/nginx-bbs.conf 
server {
        listen         8080;
        root /usr/local/nginx/html;
        index index.htm index.html index.php;
        location ~ \.php$
            {
              fastcgi_pass unix:/usr/local/php-fastcgi/php-fpm.sock;
              fastcgi_index index.php;
              include fastcgi.conf;
        } 
}
------------------------------------------------------------
[root@salt-server /srv/salt/prod/bbs]# cat web.sls 
include:
  - modules.php.install
  - modules.php.php-memcache
  - modules.php.php-redis
  - modules.nginx.service

php-ini:
  file.managed:
    - name: /usr/local/php-fastcgi/etc/php.ini
    - source: salt://bbs/files/php.ini-production
    - user: root
    - group: root
    - mode: 644

php-fpm:
  file.managed:
    - name: /usr/local/php-fastcgi/etc/php-fpm.conf
    - source: salt://bbs/files/php-fpm.conf.default
    - user: root
    - group: root
    - mode: 644

bbs-php:
  service.running:
    - name: php-fpm
    - enable: True
    - require:
      - cmd: php-fastcgi-service
    - watch:
      - file: php-ini
      - file: php-fpm

web-bbs:
  file.managed:
    - name: /usr/local/nginx/conf/vhost_online/bbs.conf
    - source: salt://bbs/files/nginx-bbs.conf
    - user: root
    - group: root
    - mode: 644
    - require:
      - service: bbs-php
    - watch_in:
      - service: nginx-service
------------------------------------------------------------
--top file文件
[root@salt-server /srv/salt/base]# cat top.sls 
base:
  '*':
    - init.init
prod:
  'Linux-node3*':
    - cluster.haproxy-outside
    - cluster.haproxy-outside-keepalived
    - bbs.memcached
    - bbs.web

  'Linux-node4*':
    - cluster.haproxy-outside
    - cluster.haproxy-outside-keepalived
    - bbs.memcached
    - bbs.web
------------------------------------------------------------



##使master端用job_cache写入到mysql
master端的job_cache路径：/var/cache/salt/master/jobs/下
minion端正在运行的salt程序id路径：/var/cache/salt/minion/proc下

#使master的job_cache写入到mysql数据库
第一步：修改master的配置文件/etc/salt/master
添加：
master_job_cache: mysql
mysql.user: salt
mysql.pass: salt
mysql.host: localhost 
mysql.port: 3306
mysql.db: salt

第二步：重启master
[root@salt-server ~]# systemctl restart salt-master.service 
结果：以后每次执行的结果就都会从master的job_cache写入到mysql上了，从job_cache写入到mysql上的这种方法都用在生产环境中。

#salt-run这个命令是在master上执行的，并非在minion上执行的，而salt这个命令是master分发工作给minion执行的
列出正在运行的jid：salt-run jobs.list_jobs
显示指定的jid执行情况：salt-run jobs.lookup_jid jid
在master端执行看minion的状态：
- salt-run manage.status
- salt-run manage.up
- salt-run manage.down
在master端执行看minion的版本：salt-run manage.versions

###无master状态下运行salt
就是只一台机器minion，它想运行salt，就可以使用salt-call命令。
第零步：关闭master-minion进程，因为本地运行，不用跟master建立连接，所以进程也没必要开启
第一步：vim /etc/salt/minion，把状态文件客户端从远端改成本地：
#file_client: remote
file_client: local
第二步：设置salt和pillar环境：
file_roots:
  base: /srv/salt/base
pillar_roots:
  base: /srv/pillar/base
第三步：本地编写sls文件
第四步：salt-call --local state.highstate
###一键安装master:cobbler自动化安装时已经安装好salt-minion,在minion上执行salt-call --local state.highstate执行master状态文件安装，使本机安装并配置好master

###多master，Multi-Master
共享：（1.可以使用NFS共享，只限内网指定IP连接2.把共享的信息放到git上，再重装个master[用得不多可以用一个master]）
1. keys (master,minion的公钥和私钥)
2. file_roots的文件
3. pillar_roots的文件
minion的配置：
master:
  - 192.168.1.235
  - 192.168.1.236

##salt syndic   --类似于zabbix的代理一样
[root@saltsrv ~]# yum install salt-syndic -y
salt syndic必须运行在master上，
syndic没有配置文件，通过master配置来更改。
vim /etc/salt/master编辑配置文件:
syndic_master: 192.168.56.12 --设置高级master的ip
systemctl restart salt-master  --重启服务
systemctl restart salt-syndic   --重启服务,sydnc就可以去找高级master了
这个时候192.168.56.12变成syndic了
vim /etc/salt/master：
order_masters: True  --开启高级Master 
systemctl restart salt-master
##top master和syndic的工作流程：
发：top master-->syndic-->master-->minion1,minion2
收：minion1,minion2-->syndic,master-->top master
syndic的file_roots和pillar_roots必须和top master高度一致(用共享或git来保持)
缺点：top master不知道自己到底有多少minion

##salt-SSH:
salt的0.17版本就支持salt-ssh了
salt-ssh 是串行的，minion是并行的，所以salt-ssh慢于minion

master安装salt-ssh:yum install salt-ssh -y
vim /etc/salt/roster   --salt-ssh的配置文件
Linux-node3-salt:
  host: 192.168.1.232
  user: root
  port: 22
Linux-node4-salt:
  host: 192.168.1.231
  user: root
  port: 22

使用命令完成秘钥的拷贝认证：salt-ssh '*' test.ping -i
！！-i是交互模式，当你输入密码时，salt-ssh会把自己的公钥拷贝到目标机器的~/.ssh/authorized_keys文件中，当下次salt-ssh链接目标机器时，就会用自己的私钥去解密目标主机自己存放的公钥，就不会再要输入密码了
salt-ssh的公私钥路径：/etc/salt/pki/master/ssh/目录下

salt-ssh使用：
salt-ssh '*' -r 'ifconfig'

salt-ssh生产环境使用得比较少，一般结合master和minion来用，
用salt-ssh 安装minion,升级minion等。

细节：远程的时候老是要询问是否连接，可以在目标机器上~/.ssh/目录下建立config文件，并添加：StricHostKeyChecking no 即可

####salt API:进行salt的管理
python框架：
http://docs.saltstack.cn/ref/netapi/all/salt.netapi.rest_cherrypy.html
1.https证书
2.配置文件
3.验证。使用PAM验证
4.启动salt-api

建用户：
[root@salt-server ~]# useradd -M -s /sbin/nologin saltapi
设密码：
[root@salt-server ~]# passwd saltapi
Changing password for user saltapi.
New password:
BAD PASSWORD: The password is shorter than 8 characters
Retype new password:
passwd: all authentication tokens updated successfully.
第一步：证书：
1.[root@salt-server /etc/pki/tls/certs]# make testcert
# 生成自签名证书, 过程中需要输入key密码及RDNs
2.[root@salt-server /etc/pki/tls/certs]# ls  //生成了localhost.crt证书
ca-bundle.crt        localhost.crt    Makefile
ca-bundle.trust.crt  make-dummy-cert  renew-dummy-cert
3.[root@salt-server /etc/pki/tls/certs]# cd ../private/
4.[root@salt-server /etc/pki/tls/private]# ls
localhost.key  //生成了localhost.key秘钥
5.[root@salt-server /etc/pki/tls/private]# openssl rsa -in localhost.key -out salt_nopass.key  
# 解密key文件，生成无密码的key文件, 过程中需要输入key密码，该密码为之前生成证书时设置的密码
Enter pass phrase for localhost.key:
writing RSA key
--------------
插曲：openssl的常见用法
CA 自签证书
生成私钥
cd /etc/pki/CA/(umask 066; openssl genrsa -out/etc/pki/CA/private/cakey.pem 2048)
生成自签名证书
openssl req -new -x509 –key /etc/pki/CA/private/cakey.pem -days 7300 -out /etc/pki/CA/cacert.pem

-new: 生成新证书签署请求
-x509: 专用于CA 生成自签证书
-key: 生成请求时用到的私钥文件
-days n ：证书的有效期限
-out / PATH/TO/SOMECERTFILE : 证书的保存路径

1：在需要使用证书的主机生成证书请求。
给web服务器生成私钥
(umask 066; openssl genrsa -out /etc/pki/tls/private/service.key 2048)
生成证书申请文件
openssl req -new -key /etc/pki/tls/private/service.key -days 365 -out /etc/pki/tls/service.csr
2：将证书请求文件传输给CA
scp /etc/pki/tls/service.csr 172.16.251.13:/etc/pki/CA/
172.16.251.13：centos7 的IP
/etc/pki/tls/：指定路径
3：在centos7上为CA 签署证书，并将证书颁发给请求者（centos6）
openssl ca -in /etc/pki/tls/service.csr –out /etc/pki/CA/certs/service.crt -days 365
注意：默认国家，省，公司名称三项必须和CA一致
4：在centos7中 查看 证书中的信息：
openssl x509 -in /etc/pki/CA/certs/service.crt -noout -text
查看 指定 编号的证书状态
openssl ca -status serial
----------

1. 安装pip：yum install python2-pip -y
使用pip安装CherryPy==3.2.6组件：
2. pip install CherryPy==3.2.6
！！！python ssl报错生产当中也遇到，是一个坑。

第二步：配置：
[root@salt-server ~]# yum install salt-api -y
[root@salt-server ~]# vim /etc/salt/master
default_include: master.d/*.conf
[root@salt-server ~]# systemctl restart salt-master
[root@salt-server ~]# cd /etc/salt/master.d
[root@salt-server /etc/salt/master.d]# cat api.conf
rest_cherrypy:
  host: 192.168.1.235
  port: 8000
  ssl_crt: /etc/pki/tls/certs/localhost.crt
  ssl_key: /etc/pki/tls/private/salt_nopass.key

第三步：验证：使用PAM验证
[root@salt-server /etc/salt/master.d]# cat eauth.conf
external_auth:
  pam:
    saltapi:
      - .*   #能够执行所有模块
      - '@wheel'  #salt-key用的
      - '@runner'  #让它看机器是否存活

[root@salt-server /etc/salt/master.d]# systemctl start salt-api
[root@salt-server /etc/salt/master.d]# netstat -tunlp
tcp        0      0 192.168.1.235:8000      0.0.0.0:*               LISTEN
#注意执行步骤，否则salt-api有可能无法正常启动：
1. 先安装pip,然后安装CherryPy==3.2.6 
2. 再修master配置文件，打开/etc/salt/master.d/*.conf配置
3. 重启master服务，并配置api.conf和eauth.conf配置
4. 重启salt-api服务

#####获取token
[root@salt-server /etc/salt/master.d]# curl -k https://192.168.1.235:8000/login \
> -H 'Accept: application/x-yaml' \
> -d username='saltapi' \
> -d password='saltapi' \
> -d eauth='pam'
return:
- eauth: pam
  expire: 1546972037.344875
  perms:
  - .*
  - '@wheel'
  - '@runner'
  start: 1546928837.344873
  token: 7453b2facb592ffa7be3b1c1de4e2a51d796acf4
  user: saltapi

###查询Minion(Linux-node3-salt)的信息
[root@salt-server ~]# curl  -k https://192.168.1.235:8000/minions/Linux-node3-salt \
> -H "Accept: application/x-yaml" \
> -H "X-Auth-Token: 7453b2facb592ffa7be3b1c1de4e2a51d796acf4"
return:
- Linux-node3-salt:
    SSDs: []
    biosreleasedate: 09/30/2014
    biosversion: '6.00'
    cpu_flags:
    - fpu
    - vme
    - de
    - pse
    - tsc
    - msr
    - pae
    - .........


###job管理
获取缓存的jobs列表
[root@salt-server ~]# curl  -k https://192.168.1.235:8000/jobs/ \
>  -H "Accept: application/x-yaml" \
> -H "X-Auth-Token: 7453b2facb592ffa7be3b1c1de4e2a51d796acf4"

return:
- '20190107220235665576':
    Arguments: []
    Function: runner.manage.versions
    StartTime: 2019, Jan 07 22:02:35.665576
    Target: salt-server_master
    Target-type: list
    User: root
  '20190107220236473477':
    Arguments: []
    Function: test.version
    StartTime: 2019, Jan 07 22:02:36.473477
    Target: '*'
    Target-type: glob
    User: root
    ............

###查询指定的job
[root@salt-server ~]# curl -k https://192.168.1.235:8000/jobs/20190108144904235175 \
> -H "Aaccept: application/x-yaml" \
> -H "X-Auth-Token: 7453b2facb592ffa7be3b1c1de4e2a51d796acf4"
{"info": [{"Function": "grains.items", "jid": "20190108144904235175", "Target": "Linux-node3-salt", "Target-type": "glob", "Result": {"Linux-node3-salt": {"fun_args": [], "jid": "20190108144904235175", "return": {"biosversion": "6.00", "kernel": "Linux", "domain": "", "uid": 0, "zmqversion": "4.1.4", "kernelrelease": "3.10.0-862.el7.x86_64", "selinux": {"enforced": "Disabled", "enabled": false}, "serialnumber": "VMware-42 2d 74 25 4d b4 e5 b4-e2 ee 35 15 66 73 cf 17", "pid": 1599, "ip_interfaces": {"lo": ["127.0.0.1", "::1"], "eth0": ["192.168.1.232", "192.168.1.236", "fe80::250:56ff:fead:4c16"]}..........

###远程执行模块
#client="local"  #类似本地salt
[root@salt-server ~]# curl  -k https://192.168.1.235:8000/ \
> -H "Aaccept: application/x-yaml" \
> -H "X-Auth-Token: 7453b2facb592ffa7be3b1c1de4e2a51d796acf4" \
> -d client="local" \
> -d tgt="*" \
> -d fun="test.ping" 
{"return": [{"Linux-node6-slave-mysql": true, "Linux-node3-salt": true, "Linux-node1-salt": true, "Linux-node5-master-mysql": true, "salt-server": true, "Linux-node4-salt": true}]}

###运行runner,(salt-run)
[root@salt-server ~]# curl  -k https://192.168.1.235:8000/ \
> -H "Aaccept: application/x-yaml" \
> -H "X-Auth-Token: 7453b2facb592ffa7be3b1c1de4e2a51d796acf4" \
> -d client="runner" \
> -d tgt="manage.status" 
return:
- down: []
  up:
  - Linux-node1-salt
  - Linux-node3-salt
  - Linux-node4-salt
  - Linux-node5-master-mysql
  - Linux-node6-slave-mysql
  - salt-server

###运行wheel
#类似获取salt-key一样
[root@salt-server ~]# curl -k https://192.168.1.235:8000/ \
> -H "Accept: application/x-yaml" \
> -H "X-Auth-Token: 7453b2facb592ffa7be3b1c1de4e2a51d796acf4" \
> -d client="wheel" \
> -d fun='key.list_all'
return:
- data:
    _stamp: '2019-01-08T07:07:51.835321'
    fun: wheel.key.list_all
    jid: '20190108150750623661'
    return:
      local:
      - master.pem
      - master.pub
      minions:
      - Linux-node1-salt
      - Linux-node3-salt
      - Linux-node4-salt
      - Linux-node5-master-mysql
      - Linux-node6-slave-mysql
      - salt-server
      minions_denied: []
      minions_pre:
      - cobbler-server
      - zabbix-proxy
      - zabbix-server
      minions_rejected: []
    success: true
    tag: salt/wheel/20190108150750623661
    user: saltapi
  tag: salt/wheel/20190108150750623661

#资料：
www.github.com/binbin91/oms
oms系统:
git clone --depth 1 https://www.github.com/binbin91/oms
saltshaker系统:
https://github.com/yueyongyue/saltshaker


</pre>